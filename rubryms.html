<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Creador de Rúbricas de Evaluación</title>
    <!-- Carga de Tailwind CSS para estilos modernos y responsivos -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Carga de jsPDF para la generación de PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- Carga de jspdf-autotable para un mejor manejo de tablas en PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.21/jspdf.plugin.autotable.min.js"></script>
    <!-- Carga de Font Awesome para iconos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <style>
        /* Definición de la paleta de colores personalizada */
        :root {
            --color-primary-light: #5CCBFA; /* Azul claro */
            --color-primary-light-hover: #45b2e0;
            --color-primary-dark: #5C67FA;  /* Azul más oscuro/púrpura */
            --color-primary-dark-hover: #454ecf;
            --color-accent-light: #95FAF8;  /* Cian muy claro */
            --color-accent-light-hover: #7cdbdb;
            --color-accent-medium: #B0CCFA; /* Azul pálido */
            --color-accent-medium-hover: #9bb7e0;

            --color-gray-dark: #6B7280; /* Para botones deshabilitados o de fondo gris */
            --color-gray-text: #F9FAFB; /* Texto en botones deshabilitados */
        }

        /* Estilos generales para el cuerpo de la página y la fuente Inter */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* Color de fondo suave */
            color: #2d3748; /* Color de texto principal */
            height: 100vh; /* Asegura que el body ocupe toda la altura del viewport */
            margin: 0;
            display: flex;
            flex-direction: column;
        }
        html {
            height: 100%; /* Asegura que html ocupe toda la altura */
        }
        /* Estilos para celdas editables al enfocarse */
        [contenteditable]:focus {
            outline: 2px solid var(--color-primary-light); /* Borde azul de Tailwind */
            background-color: #ebf8ff; /* Fondo azul claro de Tailwind */
        }
        /* Estilos para celdas de puntuación en modo de evaluación */
        .rubric-score-cell {
            text-align: center; /* Centrar texto en celdas de puntuación */
        }
        .rubric-score-cell:hover {
            background-color: var(--color-accent-medium-hover); /* Color de fondo al pasar el ratón (hover) */
            cursor: pointer; /* Cambiar cursor a puntero para indicar interactividad */
        }
        /* Estilo para la celda de puntuación seleccionada */
        .rubric-score-cell.selected {
            background-color: var(--color-accent-medium); /* Color azul más oscuro para la celda seleccionada */
            font-weight: bold; /* Texto en negrita para la celda seleccionada */
            border: 2px solid var(--color-primary-dark); /* Borde más pronunciado para la selección */
        }
        /* Clase base para todas las pantallas, inicialmente oculta */
        .screen {
            display: none;
        }
        /* Clase para la pantalla activa */
        .screen.active {
            display: block;
        }
        /* Estilo para resaltar el div del grupo cargado */
        .student-group-item.selected-group {
            border-color: var(--color-primary-light) !important;
            background-color: #ebf8ff !important;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06) !important;
        }

        /* Contenedor de grupos de estudiantes - ahora es un <div> que contendrá divs de grupo */
        #studentGroupsListContainer { /* Nuevo ID para el contenedor de la lista de grupos */
            background-color: var(--color-accent-light); /* Fondo suave */
            padding: 1rem; /* Relleno */
            border-radius: 0.5rem;
            overflow: auto; /* Permite scroll si hay muchos grupos */
            border: 1px solid var(--color-accent-medium); /* Borde suave */
            display: flex; /* Contenedor flex para los items de grupo */
            flex-direction: column; /* Apila los items verticalmente */
            gap: 0.75rem; /* Espacio entre los items */
        }

        /* Estilos para los items individuales de grupo (ahora son divs, con estilo mínimo) */
        .student-group-item {
            background-color: #fff; /* Fondo blanco */
            border-bottom: 1px solid #e2e8f0; /* Separador sutil */
            padding: 0.75rem 0; /* Relleno vertical */
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        .student-group-item:first-child {
            padding-top: 0; /* No padding-top para el primer elemento si el contenedor ya tiene padding */
        }
        .student-group-item:last-child {
            border-bottom: none; /* Sin borde inferior para el último elemento */
            padding-bottom: 0;
        }

        @media (min-width: 768px) {
            .student-group-item {
                flex-direction: row;
                align-items: center;
            }
        }
        .student-group-item:hover {
            background-color: #f7fafc; /* Efecto hover en las filas */
        }
        .student-group-item .ml-auto {
            margin-left: auto;
            margin-top: 0.5rem; /* Ajuste para espacio entre texto y botones en móvil */
        }
        @media (min-width: 768px) {
            .student-group-item .ml-auto {
                margin-top: 0;
            }
        }

        /* Oculta el mensaje "No hay grupos" si hay grupos */
        #studentGroupsListContainer:not(:empty):not(:has(p:not(#noGroupsMessage))) #noGroupsMessage {
            display: none; /* Oculta el mensaje si hay otros elementos (grupos) */
        }
        #noGroupsMessage {
            text-align: center;
            padding: 1rem;
            color: #6B7280;
            display: block; /* Asegura que el mensaje por defecto siempre sea display: block */
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-4xl mx-auto bg-white shadow-xl rounded-lg p-6 space-y-8">
        <h1 class="text-3xl font-bold text-center text-blue-700 mb-6">Herramienta de Evaluación de Rúbricas</h1>

        <!-- Menú de Navegación -->
        <nav class="mb-8 bg-gray-100 p-4 rounded-md shadow-sm flex flex-wrap justify-center gap-4">
            <button id="navRubric" class="nav-button bg-[color:var(--color-primary-dark)] text-white py-2 px-4 rounded-md hover:bg-[color:var(--color-primary-dark-hover)] transition duration-200 font-semibold" data-screen="rubricScreen"><i class="fas fa-edit mr-2"></i>Rúbrica</button>
            <button id="navStudents" class="nav-button bg-[color:var(--color-gray-dark)] text-[color:var(--color-gray-text)] py-2 px-4 rounded-md cursor-not-allowed font-semibold" disabled data-screen="studentsScreen"><i class="fas fa-users mr-2"></i>Gestionar</button>
            <button id="navGroupsList" class="nav-button bg-[color:var(--color-gray-dark)] text-[color:var(--color-gray-text)] py-2 px-4 rounded-md cursor-not-allowed font-semibold" disabled data-screen="listGroupsScreen"><i class="fas fa-list-alt mr-2"></i>Grupos</button>
            <button id="navEvaluate" class="nav-button bg-[color:var(--color-gray-dark)] text-[color:var(--color-gray-text)] py-2 px-4 rounded-md cursor-not-allowed font-semibold" disabled data-screen="evaluationScreen"><i class="fas fa-check-circle mr-2"></i>Evaluar</button>
            <button id="navExport" class="nav-button bg-[color:var(--color-gray-dark)] text-[color:var(--color-gray-text)] py-2 px-4 rounded-md cursor-not-allowed font-semibold" disabled data-screen="exportScreen"><i class="fas fa-file-pdf mr-2"></i>Exportar</button>
        </nav>

        <!-- Sección de Cargar Rúbrica desde CSV (Pantalla 1) -->
        <div id="rubricScreen" class="screen active bg-[color:var(--color-accent-light)] p-6 rounded-lg border border-[color:var(--color-accent-medium)]">
            <h2 class="text-2xl font-semibold text-[color:var(--color-primary-dark)] mb-4"><i class="fas fa-clipboard-list mr-2"></i>1. Configurar Rúbrica</h2>

            <!-- Campos de metadatos de la rúbrica -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <div>
                    <label for="institutionInput" class="block text-gray-700 font-medium mb-1">Institución Educativa:</label>
                    <div class="flex space-x-2">
                        <select id="institutionSelect" class="flex-grow p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-[color:var(--color-primary-light)]"></select>
                        <input type="text" id="newInstitutionInput" class="p-2 border border-gray-300 rounded-md flex-grow" placeholder="Nueva institución">
                        <button id="addInstitutionBtn" class="bg-[color:var(--color-primary-light)] text-white p-2 rounded-md hover:bg-[color:var(--color-primary-light-hover)] transition duration-200"><i class="fas fa-plus"></i></button>
                    </div>
                </div>
                <div>
                    <label for="courseInput" class="block text-gray-700 font-medium mb-1">Curso/Módulo:</label>
                    <div class="flex space-x-2">
                        <select id="courseSelect" class="flex-grow p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-[color:var(--color-primary-light)]"></select>
                        <input type="text" id="newCourseInput" class="p-2 border border-gray-300 rounded-md flex-grow" placeholder="Nuevo curso">
                        <button id="addCourseBtn" class="bg-[color:var(--color-primary-light)] text-white p-2 rounded-md hover:bg-[color:var(--color-primary-light-hover)] transition duration-200"><i class="fas fa-plus"></i></button>
                    </div>
                </div>
                <div>
                    <label for="teacherInput" class="block text-gray-700 font-medium mb-1">Docente:</label>
                    <div class="flex space-x-2">
                        <select id="teacherSelect" class="flex-grow p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-[color:var(--color-primary-light)]"></select>
                        <input type="text" id="newTeacherInput" class="p-2 border border-gray-300 rounded-md flex-grow" placeholder="Nuevo docente">
                        <button id="addTeacherBtn" class="bg-[color:var(--color-primary-light)] text-white p-2 rounded-md hover:bg-[color:var(--color-primary-light-hover)] transition duration-200"><i class="fas fa-plus"></i></button>
                    </div>
                </div>
                <div>
                    <label for="sessionTitleInput" class="block text-gray-700 font-medium mb-1">Título de la Sesión:</label>
                    <input type="text" id="sessionTitleInput" class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-[color:var(--color-primary-light)]">
                </div>
                <div>
                    <label for="dateInput" class="block text-gray-700 font-medium mb-1">Fecha:</label>
                    <input type="date" id="dateInput" class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-[color:var(--color-primary-light)]">
                </div>
            </div>

            <label for="rubricInput" class="block text-gray-700 font-medium mb-2">Pega aquí el texto CSV de tu rúbrica:</label>
            <textarea id="rubricInput"
                      class="w-full h-32 p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-[color:var(--color-primary-light)] mb-4 text-sm"
                      placeholder="Aspectos;Destacado (5);Logrado (4);Proceso (3);Inicio (2);Previo al Inicio (1)
Contenido;La información es completa...;La información es clara...;..."></textarea>
            <button id="loadRubricBtn"
                    class="w-full bg-[color:var(--color-primary-dark)] text-white py-3 px-6 rounded-md shadow-md hover:bg-[color:var(--color-primary-dark-hover)] transition duration-300 ease-in-out font-semibold">
                <i class="fas fa-file-import mr-2"></i>Cargar Rúbrica
            </button>
            <div id="rubricDisplay" class="mt-6 overflow-x-auto">
                <!-- La rúbrica cargada y editable se mostrará aquí -->
            </div>
        </div>

        <!-- Sección para Gestionar Lista de Estudiantes (Pantalla 2) -->
        <div id="studentsScreen" class="screen bg-[color:var(--color-accent-light)] p-6 rounded-lg border border-[color:var(--color-accent-medium)]">
            <h2 class="text-2xl font-semibold text-[color:var(--color-primary-dark)] mb-4"><i class="fas fa-users mr-2"></i>2. Gestionar Grupos de Estudiantes</h2>

            <div class="mb-6">
                <label for="groupNameInput" class="block text-gray-700 font-medium mb-1">Nombre del Grupo:</label>
                <input type="text" id="groupNameInput" class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-[color:var(--color-primary-light)] mb-2" placeholder="Ej. Grupo A - 2025">
                <label for="studentsInput" class="block text-gray-700 font-medium mb-1">Lista de Estudiantes (uno por línea):</label>
                <textarea id="studentsInput"
                          class="w-full h-24 p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-[color:var(--color-primary-light)] mb-4 text-sm"
                          placeholder="Juan Pérez
María García
Carlos Soto"></textarea>
                <button id="saveStudentGroupBtn"
                        class="w-full bg-[color:var(--color-primary-dark)] text-white py-3 px-6 rounded-md shadow-md hover:bg-[color:var(--color-primary-dark-hover)] transition duration-300 ease-in-out font-semibold">
                    <i class="fas fa-save mr-2"></i>Guardar Grupo de Estudiantes
                </button>
                <p class="text-sm text-gray-600 mt-2">Puedes agregar o actualizar grupos. Se mostrarán en la pantalla "Lista Grupos".</p>
            </div>
        </div>

        <!-- Nueva Sección para Lista de Grupos (Pantalla 3) -->
        <div id="listGroupsScreen" class="screen bg-[color:var(--color-accent-light)] p-6 rounded-lg border border-[color:var(--color-accent-medium)]">
            <h2 class="text-2xl font-semibold text-[color:var(--color-primary-dark)] mb-4"><i class="fas fa-list-alt mr-2"></i>Lista de Grupos Guardados</h2>
            <div id="studentGroupsListContainer"> <!-- Contenedor específico para la lista de grupos -->
                <p id="noGroupsMessage" class="text-sm text-gray-500 text-center">No hay grupos de estudiantes guardados.</p>
                <!-- Los divs de grupo se cargarán aquí dinámicamente -->
            </div>
        </div>

        <!-- Sección de Evaluación de Estudiantes (Pantalla 4) -->
        <div id="evaluationScreen" class="screen bg-[color:var(--color-accent-light)] p-6 rounded-lg border border-[color:var(--color-accent-medium)]">
            <h2 class="text-2xl font-semibold text-[color:var(--color-primary-dark)] mb-4"><i class="fas fa-marker mr-2"></i>3. Evaluar a <span id="currentStudentName" class="text-[color:var(--color-primary-dark)]"></span> del grupo <span id="currentGroupName" class="text-[color:var(--color-primary-dark)]"></span></h2>
            <div id="studentSelectContainer" class="mb-4">
                <label for="studentSelect" class="block text-gray-700 text-lg font-medium mb-2">Seleccionar Estudiante:</label>
                <select id="studentSelect" class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-[color:var(--color-primary-light)] text-base"></select>
                <p id="noStudentsInGroupMessage" class="text-sm text-red-500 mt-2 hidden">No hay estudiantes en este grupo.</p>
            </div>

            <div class="flex justify-between items-center bg-[color:var(--color-accent-medium)] p-3 rounded-md mb-4 font-semibold text-lg text-gray-800">
                <span>Puntaje Total: <span id="totalScoreDisplay" class="text-[color:var(--color-primary-dark)]">0</span></span>
                <span>Promedio: <span id="averageScoreDisplay" class="text-[color:var(--color-primary-dark)]">0.00</span></span>
            </div>

            <div id="studentRubricEvaluation" class="overflow-x-auto mb-6">
                <!-- La rúbrica para evaluación del estudiante actual se renderizará aquí -->
            </div>
            <div class="flex flex-col md:flex-row justify-between items-center space-y-4 md:space-y-0 md:space-x-4">
                <button id="prevStudentBtn"
                        class="w-full md:w-auto bg-gray-500 text-white py-3 px-6 rounded-md shadow-md hover:bg-gray-600 transition duration-300 ease-in-out font-semibold disabled:opacity-50">
                    <i class="fas fa-arrow-left mr-2"></i>Anterior Estudiante
                </button>
                <button id="nextStudentBtn"
                        class="w-full md:w-auto bg-[color:var(--color-primary-dark)] text-white py-3 px-6 rounded-md shadow-md hover:bg-[color:var(--color-primary-dark-hover)] transition duration-300 ease-in-out font-semibold disabled:opacity50">
                    Siguiente Estudiante<i class="fas fa-arrow-right ml-2"></i>
                </button>
            </div>
        </div>

        <!-- Sección de Exportación de Evaluaciones (Pantalla 5) -->
        <div id="exportScreen" class="screen bg-[color:var(--color-accent-light)] p-6 rounded-lg border border-[color:var(--color-accent-medium)]">
            <h2 class="text-2xl font-semibold text-[color:var(--color-primary-dark)] mb-4"><i class="fas fa-file-export mr-2"></i>4. Exportar Evaluaciones</h2>
            <button id="exportRubricsBtn"
                    class="w-full bg-[color:var(--color-primary-dark)] text-white py-3 px-6 rounded-md shadow-md hover:bg-[color:var(--color-primary-dark-hover)] transition duration-300 ease-in-out font-semibold disabled:opacity-50">
                <i class="fas fa-file-pdf mr-2"></i>Exportar Todas las Rúbricas a PDF
            </button>
            <p class="text-sm text-gray-600 mt-4 text-center">
                Se generará un archivo PDF con una rúbrica por estudiante para el grupo actualmente seleccionado.
            </p>
        </div>

        <!-- Área de Mensajes para el Usuario -->
        <div id="messageArea" class="mt-6 p-4 rounded-md text-sm text-center hidden"></div>
    </div>

    <script>
        // Variables globales para almacenar el estado de la aplicación
        let rubricTemplate = [];
        let rubricMetadata = {
            institution: '',
            course: '',
            sessionTitle: '',
            teacher: '',
            date: ''
        };
        let allStudentGroups = []; 
        let currentStudentsInGroup = [];
        let currentSelectedGroupName = '';
        let currentStudentIndex = -1;
        let currentScreenId = 'rubricScreen';

        let persistentInstitutions = [];
        let persistentCourses = [];
        let persistentTeachers = [];
        let evaluations = {};

        // Obtener referencias a los elementos del DOM (Rubric Screen)
        let rubricInput, loadRubricBtn, rubricDisplay, institutionSelect, newInstitutionInput, addInstitutionBtn;
        let courseSelect, newCourseInput, addCourseBtn, teacherSelect, newTeacherInput, addTeacherBtn;
        let sessionTitleInput, dateInput;

        // Obtener referencias a los elementos del DOM (Students Screen)
        let groupNameInput, studentsInput, saveStudentGroupBtn;

        // Obtener referencias a los elementos del DOM (List Groups Screen)
        let studentGroupsListContainer; 
        let noGroupsMessage; 

        // Obtener referencias a los elementos del DOM (Evaluation Screen)
        let currentStudentNameSpan, currentGroupNameSpan, studentSelectContainer, studentSelect, noStudentsInGroupMessage;
        let studentRubricEvaluationDiv, prevStudentBtn, nextStudentBtn;
        let totalScoreDisplay, averageScoreDisplay;

        // Obtener referencias a los elementos del DOM (Export Screen)
        let exportRubricsBtn;
        let messageArea;

        // Referencias a los botones de navegación y las pantallas
        let navButtons;
        let screens;

        // Inicializar jsPDF
        const { jsPDF } = window.jspdf;

        /**
         * Funciones para manejar localStorage
         */
        function saveToLocalStorage(key, data) {
            try {
                localStorage.setItem(key, JSON.stringify(data));
                console.log(`Saved to localStorage for key: ${key}. Data:`, data);
            } catch (e) {
                console.error('Error saving to localStorage:', e);
                showMessage('Error al guardar datos. El almacenamiento local puede estar lleno.', 'error');
            }
        }

        function loadFromLocalStorage(key) {
            console.log(`Loading from localStorage for key: ${key}`);
            try {
                const data = localStorage.getItem(key);
                console.log(`Loaded raw data for ${key}:`, data);
                if (data) {
                    const parsedData = JSON.parse(data);
                    console.log(`Parsed data for ${key}:`, parsedData);
                    return parsedData;
                }
                return null;
            } catch (e) {
                console.error(`Error loading from localStorage for key ${key}:`, e);
                return null;
            }
        }

        /**
         * Muestra un mensaje al usuario en el área de mensajes.
         * @param {string} message - El mensaje a mostrar.
         * @param {string} type - El tipo de mensaje ('success', 'error', 'info'). Determina el color del fondo.
         */
        function showMessage(message, type = 'info') {
            const messageArea = document.getElementById('messageArea');
            if (!messageArea) return;
            messageArea.textContent = message;
            messageArea.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-700', 'bg-blue-100', 'text-blue-700');
            if (type === 'error') {
                messageArea.classList.add('bg-red-100', 'text-red-700');
            } else if (type === 'success') {
                messageArea.classList.add('bg-green-100', 'text-green-700');
            } else {
                messageArea.classList.add('bg-blue-100', 'text-blue-700');
            }
            messageArea.classList.remove('hidden');
        }

        /**
         * Rellena un elemento <select> con opciones de una lista.
         * @param {HTMLSelectElement} selectElement - El elemento <select> a rellenar.
         * @param {Array<string>} items - La lista de elementos a añadir como opciones.
         */
        function populateSelect(selectElement, items) {
            if (!selectElement) return;
            selectElement.innerHTML = '';
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = '-- Seleccionar --';
            selectElement.appendChild(defaultOption);

            items.forEach(item => {
                const option = document.createElement('option');
                option.value = item;
                option.textContent = item;
                selectElement.appendChild(option);
            });
        }

        /**
         * Renderiza los elementos de la lista de grupos de estudiantes.
         * Esta función ahora trabaja con allStudentGroups y renderiza divs.
         */
        function renderAllStudentGroups() {
            const container = document.getElementById('studentGroupsListContainer');
            const msgNoGroups = document.getElementById('noGroupsMessage');
            const navEvaluateButton = document.getElementById('navEvaluate');
            const navExportButton = document.getElementById('navExport');

            console.log("renderAllStudentGroups called. Student groups:", allStudentGroups.length, allStudentGroups);

            if (!container || !msgNoGroups || !navEvaluateButton || !navExportButton) {
                console.warn("Elementos DOM para la lista de grupos no listos. Saltando renderización.");
                return;
            }

            // Limpiar el contenedor completamente antes de volver a renderizar
            container.innerHTML = ''; 

            if (allStudentGroups.length === 0) {
                noGroupsMessage.classList.remove('hidden'); 
                navEvaluateButton.disabled = true;
                navEvaluateButton.classList.remove('bg-[color:var(--color-primary-dark)]', 'text-white', 'hover:bg-[color:var(--color-primary-dark-hover)]');
                navEvaluateButton.classList.add('bg-[color:var(--color-gray-dark)]', 'text-[color:var(--color-gray-text)]', 'cursor-not-allowed');
                
                navExportButton.disabled = true;
                navExportButton.classList.remove('bg-[color:var(--color-primary-dark)]', 'text-white', 'hover:bg-[color:var(--color-primary-dark-hover)]');
                navExportButton.classList.add('bg-[color:var(--color-gray-dark)]', 'text-[color:var(--color-gray-text)]', 'cursor-not-allowed');

                container.appendChild(msgNoGroups);
                console.log("renderAllStudentGroups: No groups, noGroupsMessage is VISIBLE.");
                return;
            } else {
                noGroupsMessage.classList.add('hidden');
                enableNavButton(navEvaluateButton);
                enableNavButton(navExportButton); // Enable export button here too
                console.log("renderAllStudentGroups: Groups found, noGroupsMessage is HIDDEN, navEvaluate is ENABLED.");
            }

            allStudentGroups.forEach(group => {
                const groupDiv = document.createElement('div');
                groupDiv.className = 'student-group-item'; // Clase para los estilos de item de grupo
                groupDiv.dataset.groupId = group.id;

                const nameElement = document.createElement('span');
                nameElement.className = 'flex-grow text-lg font-medium text-gray-800';
                nameElement.textContent = group.groupName;

                const studentCountElement = document.createElement('span');
                studentCountElement.className = 'text-sm text-gray-600 md:ml-4';
                studentCountElement.textContent = `${group.students.length} estudiantes`;

                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'flex space-x-2 ml-auto mt-2 md:mt-0';

                const loadBtn = document.createElement('button');
                loadBtn.className = 'bg-[color:var(--color-primary-light)] text-white py-1 px-3 rounded-md hover:bg-[color:var(--color-primary-light-hover)] transition duration-200 text-sm font-semibold';
                loadBtn.innerHTML = '<i class="fas fa-folder-open mr-1"></i> Cargar';
                loadBtn.addEventListener('click', (event) => {
                    event.stopPropagation();
                    loadStudentGroupForEvaluation(group.id); // Renombrado para claridad
                    showScreen('evaluationScreen');
                    console.log("Load button clicked for group:", group.groupName);
                });

                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'bg-red-500 text-white py-1 px-3 rounded-md hover:bg-red-600 transition duration-200 text-sm font-semibold';
                deleteBtn.innerHTML = '<i class="fas fa-trash-alt mr-1"></i> Eliminar';
                deleteBtn.addEventListener('click', (event) => {
                    event.stopPropagation();
                    if (confirm(`¿Estás seguro de que quieres eliminar el grupo "${group.groupName}" y sus evaluaciones asociadas?`)) {
                        deleteStudentGroup(group.id);
                        console.log("Delete button clicked for group:", group.groupName);
                    }
                });

                actionsDiv.appendChild(loadBtn);
                actionsDiv.appendChild(deleteBtn);

                groupDiv.appendChild(nameElement);
                groupDiv.appendChild(studentCountElement);
                groupDiv.appendChild(actionsDiv);

                container.appendChild(groupDiv); // Añadir el div de grupo al contenedor de lista
                console.log("Group div appended for group:", group.groupName);

                if (group.groupName === currentSelectedGroupName) {
                    groupDiv.classList.add('selected-group');
                }
            });
            console.log("renderAllStudentGroups finished.");
        }

        /**
         * Carga los datos persistentes (instituciones, cursos, docentes, grupos de estudiantes y evaluaciones) de localStorage.
         */
        function loadPersistentData() {
            console.log("loadPersistentData called.");

            persistentInstitutions = loadFromLocalStorage('persistentInstitutions') || [];
            populateSelect(document.getElementById('institutionSelect'), persistentInstitutions);

            persistentCourses = loadFromLocalStorage('persistentCourses') || [];
            populateSelect(document.getElementById('courseSelect'), persistentCourses);

            persistentTeachers = loadFromLocalStorage('persistentTeachers') || [];
            populateSelect(document.getElementById('teacherSelect'), persistentTeachers);

            // Cargar grupos de estudiantes
            allStudentGroups = loadFromLocalStorage('allStudentGroups') || []; // Usar el nuevo nombre de la clave
            renderAllStudentGroups(); // Renderizar los grupos cargados al inicio

            // Cargar evaluaciones
            evaluations = loadFromLocalStorage('evaluations') || {};

            console.log("Data loaded from localStorage.");
        }

        /**
         * Actualiza los metadatos de la rúbrica desde los campos de entrada.
         */
        function updateRubricMetadata() {
            rubricMetadata.institution = institutionSelect ? institutionSelect.value : '';
            rubricMetadata.course = courseSelect ? courseSelect.value : '';
            rubricMetadata.sessionTitle = sessionTitleInput ? sessionTitleInput.value : '';
            rubricMetadata.teacher = teacherSelect ? teacherSelect.value : '';
            rubricMetadata.date = dateInput ? dateInput.value : '';
        }

        /**
         * Carga la rúbrica desde el textarea y la muestra.
         */
        function loadRubricBtnHandler() {
            const csvText = rubricInput.value;
            rubricTemplate = parseCSV(csvText);
            if (rubricTemplate.length > 0 && rubricTemplate[0].length > 0) {
                renderRubricTable(rubricTemplate, rubricDisplay, true, false);
                showMessage('Rúbrica cargada y editable.', 'success');
                const navStudentsButton = document.getElementById('navStudents');
                if(navStudentsButton) enableNavButton(navStudentsButton);
                const navGroupsListButton = document.getElementById('navGroupsList'); // Habilitar nuevo botón
                if(navGroupsListButton) enableNavButton(navGroupsListButton);
                const navEvaluateButton = document.getElementById('navEvaluate');
                if(navEvaluateButton) enableNavButton(navEvaluateButton);
                const navExportButton = document.getElementById('navExport');
                if(navExportButton) enableNavButton(navExportButton);

                updateRubricMetadata();
            } else {
                rubricDisplay.innerHTML = '<p class="text-center text-red-500">No se pudo cargar la rúbrica. Asegúrate de que el formato CSV sea correcto y no esté vacío.</p>';
                showMessage('Error al cargar la rúbrica. Verifica el formato.', 'error');
                
                const navStudentsButton = document.getElementById('navStudents');
                if(navStudentsButton) {
                    navStudentsButton.disabled = true;
                    navStudentsButton.classList.remove('bg-[color:var(--color-primary-dark)]', 'text-white', 'hover:bg-[color:var(--color-primary-dark-hover)]');
                    navStudentsButton.classList.add('bg-[color:var(--color-gray-dark)]', 'text-[color:var(--color-gray-text)]', 'cursor-not-allowed');
                }
                const navGroupsListButton = document.getElementById('navGroupsList'); // Deshabilitar nuevo botón
                if(navGroupsListButton) {
                    navGroupsListButton.disabled = true;
                    navGroupsListButton.classList.remove('bg-[color:var(--color-primary-dark)]', 'text-white', 'hover:bg-[color:var(--color-primary-dark-hover)]');
                    navGroupsListButton.classList.add('bg-[color:var(--color-gray-dark)]', 'text-[color:var(--color-gray-text)]', 'cursor-not-allowed');
                }
                const navEvaluateButton = document.getElementById('navEvaluate');
                if(navEvaluateButton) {
                    navEvaluateButton.disabled = true;
                    navEvaluateButton.classList.remove('bg-[color:var(--color-primary-dark)]', 'text-white', 'hover:bg-[color:var(--color-primary-dark-hover)]');
                    navEvaluateButton.classList.add('bg-[color:var(--color-gray-dark)]', 'text-[color:var(--color-gray-text)]', 'cursor-not-allowed');
                }
                const navExportButton = document.getElementById('navExport');
                if(navExportButton) {
                    navExportButton.disabled = true;
                    navExportButton.classList.remove('bg-[color:var(--color-primary-dark)]', 'text-white', 'hover:bg-[color:var(--color-primary-dark-hover)]');
                    navExportButton.classList.add('bg-[color:var(--color-gray-dark)]', 'text-[color:var(--color-gray-text)]', 'cursor-not-allowed');
                }
            }
        }

        /**
         * Parsea el texto CSV en una matriz 2D.
         * Detecta automáticamente el delimitador (punto y coma o coma).
         * @param {string} csvText - El texto en formato CSV.
         * @returns {Array<Array<string>>} Una matriz 2D que representa los datos CSV.
         */
        function parseCSV(csvText) {
            const lines = csvText.trim().split('\n').filter(line => line.trim() !== '');
            if (lines.length === 0) return [];

            let delimiter = ';';
            if (lines[0].indexOf(';') === -1 && lines[0].indexOf(',') !== -1) {
                delimiter = ',';
            }

            function splitLine(line, delimiterChar) {
                const result = [];
                let inQuote = false;
                let currentCell = '';
                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    if (char === '"') {
                        inQuote = !inQuote;
                        if (inQuote && line[i+1] === '"') {
                           currentCell += '"';
                           i++;
                        }
                    } else if (char === delimiterChar && !inQuote) {
                        result.push(currentCell.trim());
                        currentCell = '';
                    } else {
                        currentCell += char;
                    }
                }
                result.push(currentCell.trim());
                return result;
            }
            return lines.map(line => splitLine(line, delimiter));
        }

        /**
         * Crea una tabla HTML editable a partir de una matriz 2D de datos de rúbrica.
         * @param {Array<Array<string>>} data - Los datos de la rúbrica (incluyendo encabezados).
         * @param {HTMLElement} targetDiv - El div donde se renderizará la tabla.
         * @param {boolean} editable - Si las celdas de la tabla deben ser editables (`contenteditable`).
         * @param {boolean} selectableScores - Si las celdas de puntuación deben ser clickeables para selección.
         */
        function renderRubricTable(data, targetDiv, editable = true, selectableScores = false) {
            if (!targetDiv) return;
            targetDiv.innerHTML = '';
            if (data.length === 0 || data[0].length === 0) {
                targetDiv.innerHTML = '<p class="text-center text-gray-500">No hay rúbrica para mostrar.</p>';
                return;
            }

            const table = document.createElement('table');
            table.className = 'min-w-full divide-y divide-gray-200 border border-gray-300 rounded-md';

            const thead = document.createElement('thead');
            thead.className = 'bg-[color:var(--color-accent-medium)]';
            const headerRow = document.createElement('tr');
            data[0].forEach(headerText => {
                const th = document.createElement('th');
                th.className = 'px-4 py-2 text-left text-sm font-medium text-[color:var(--color-primary-dark)] uppercase tracking-wider border-r border-gray-200 last:border-r-0';
                th.textContent = headerText;
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);
            table.appendChild(thead);

            const tbody = document.createElement('tbody');
            tbody.className = 'bg-white divide-y divide-gray-200';
            for (let i = 1; i < data.length; i++) {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                data[i].forEach((cellText, cellIndex) => {
                    const td = document.createElement('td');
                    td.className = 'px-4 py-3 whitespace-pre-wrap text-sm text-gray-800 border-r border-gray-200 last:border-r-0';
                    if (editable) {
                        td.contentEditable = 'true';
                        td.spellcheck = false;
                        td.setAttribute('data-row', i);
                        td.setAttribute('data-col', cellIndex);
                    }
                    td.textContent = cellText;

                    if (selectableScores && cellIndex > 0) {
                        td.classList.add('rubric-score-cell');
                        td.addEventListener('click', (event) => {
                            const selectedTd = event.currentTarget;
                            const rowElement = selectedTd.closest('tr');
                            rowElement.querySelectorAll('.rubric-score-cell').forEach(cell => {
                                cell.classList.remove('selected');
                            });
                            selectedTd.classList.add('selected');

                            const studentName = currentStudentsInGroup[currentStudentIndex];
                            if (!evaluations[currentSelectedGroupName]) {
                                evaluations[currentSelectedGroupName] = {};
                            }
                            if (!evaluations[currentSelectedGroupName][studentName]) {
                                evaluations[currentSelectedGroupName][studentName] = {
                                    rubricMetadata: { ...rubricMetadata },
                                    scores: {}
                                };
                            }

                            const aspect = data[i][0];
                            const scoreHeader = data[0][cellIndex];
                            const scoreMatch = scoreHeader.match(/\((\d+)\)/);
                            const score = scoreMatch ? parseInt(scoreMatch[1], 10) : 0;
                            const description = cellText;

                            evaluations[currentSelectedGroupName][studentName].scores[aspect] = { score: score, description: description };
                            saveToLocalStorage('evaluations', evaluations);
                            updateScoreDisplays();
                        });
                    }
                    row.appendChild(td);
                });
                tbody.appendChild(row);
            }
            table.appendChild(tbody);
            targetDiv.appendChild(table);

            if (editable) {
                table.addEventListener('input', (event) => {
                    const target = event.target;
                    if (target.contentEditable === 'true') {
                        const row = parseInt(target.getAttribute('data-row'), 10);
                        const col = parseInt(target.getAttribute('data-col'), 10);
                        rubricTemplate[row][col] = target.textContent;
                        showMessage('Rúbrica actualizada. Cualquier cambio afectará a futuras evaluaciones.', 'info');
                    }
                });
            }
        }

        /**
         * Maneja la visibilidad de las pantallas y el estilo del botón de navegación activo.
         * @param {string} screenId - El ID de la pantalla a mostrar.
         */
        function showScreen(screenId) {
            if (!navButtons || !screens) {
                console.warn("Botones de navegación o pantallas no inicializados.");
                return;
            }

            screens.forEach(screen => {
                screen.classList.remove('active');
                screen.style.display = 'none';
            });
            const targetScreen = document.getElementById(screenId);
            if (targetScreen) {
                targetScreen.classList.add('active');
                targetScreen.style.display = 'block';
            }

            currentScreenId = screenId;

            navButtons.forEach(button => {
                button.classList.remove('bg-[color:var(--color-primary-dark)]', 'text-white', 'hover:bg-[color:var(--color-primary-dark-hover)]');
                button.classList.remove('bg-[color:var(--color-accent-medium)]', 'text-gray-800', 'hover:bg-[color:var(--color-accent-medium-hover)]');

                if (!button.disabled) {
                     button.classList.add('bg-[color:var(--color-accent-medium)]', 'text-gray-800', 'hover:bg-[color:var(--color-accent-medium-hover)]');
                } else {
                    button.classList.add('bg-[color:var(--color-gray-dark)]', 'text-[color:var(--color-gray-text)]', 'cursor-not-allowed');
                }

                if (button.dataset.screen === screenId) {
                    button.classList.remove('bg-[color:var(--color-accent-medium)]', 'text-gray-800', 'hover:bg-[color:var(--color-accent-medium-hover)]');
                    button.classList.remove('bg-[color:var(--color-gray-dark)]', 'text-[color:var(--color-gray-text)]', 'cursor-not-allowed');
                    button.classList.add('bg-[color:var(--color-primary-dark)]', 'text-white', 'hover:bg-[color:var(--color-primary-dark-hover)]');
                }
            });
            if(messageArea) messageArea.classList.add('hidden');

            if (screenId === 'evaluationScreen') {
                if (currentSelectedGroupName && currentStudentsInGroup.length > 0) {
                    if (currentStudentIndex === -1) {
                         currentStudentIndex = 0;
                    }
                    if(studentSelect) studentSelect.value = currentStudentIndex;
                    loadStudentForEvaluation(currentStudentIndex);
                } else if (allStudentGroups.length > 0) {
                    showMessage('Selecciona un grupo de estudiantes primero.', 'info');
                    showScreen('listGroupsScreen');
                } else {
                    showMessage('Carga una rúbrica y grupos de estudiantes primero.', 'info');
                    showScreen('rubricScreen');
                }
            } else if (screenId === 'listGroupsScreen') {
                renderAllStudentGroups();
            }
        }

        /**
         * Habilita un botón de navegación.
         * @param {HTMLElement} buttonElement - El elemento del botón a habilitar.
         */
        function enableNavButton(buttonElement) {
            if (!buttonElement) return;
            buttonElement.disabled = false;
            buttonElement.classList.remove('bg-[color:var(--color-gray-dark)]', 'text-[color:var(--color-gray-text)]', 'cursor-not-allowed');
            // Aplicar el estilo por defecto de botón habilitado, si no es la pantalla activa
            if (buttonElement.dataset.screen !== currentScreenId) {
                buttonElement.classList.add('bg-[color:var(--color-accent-medium)]', 'text-gray-800', 'hover:bg-[color:var(--color-accent-medium-hover)]');
            } else { // Si es la pantalla activa, aplicar el estilo de botón activo
                buttonElement.classList.add('bg-[color:var(--color-primary-dark)]', 'text-white', 'hover:bg-[color:var(--color-primary-dark-hover)]');
            }
        }

        /**
         * Actualiza los metadatos de la rúbrica desde los campos de entrada.
         */
        function updateRubricMetadata() {
            rubricMetadata.institution = institutionSelect ? institutionSelect.value : '';
            rubricMetadata.course = courseSelect ? courseSelect.value : '';
            rubricMetadata.sessionTitle = sessionTitleInput ? sessionTitleInput.value : '';
            rubricMetadata.teacher = teacherSelect ? teacherSelect.value : '';
            rubricMetadata.date = dateInput ? dateInput.value : '';
        }

        /**
         * Adds a new persistent item to a list and saves it to localStorage.
         * @param {string} storageKey - The key for localStorage (e.g., 'persistentInstitutions').
         * @param {Array<string>} listArray - The array to add the item to (e.g., persistentInstitutions).
         * @param {HTMLInputElement} inputElement - The input field where the new item name is typed.
         * @param {HTMLSelectElement} selectElement - The select dropdown to update.
         */
        function addPersistentItem(storageKey, listArray, inputElement, selectElement) {
            const newItem = inputElement.value.trim();
            if (newItem && !listArray.includes(newItem)) {
                listArray.push(newItem);
                listArray.sort();
                populateSelect(selectElement, listArray);
                saveToLocalStorage(storageKey, listArray);
                selectElement.value = newItem;
                inputElement.value = '';
                updateRubricMetadata();
            } else if (newItem) {
                showMessage(`El elemento "${newItem}" ya existe.`, 'info');
            }
        }

        /**
         * Carga un grupo de estudiantes y los prepara para la evaluación.
         * Esta función ha sido renombrada para mayor claridad.
         * @param {string} groupId - El ID del grupo a cargar.
         */
        function loadStudentGroupForEvaluation(groupId) {
            const selectedGroup = allStudentGroups.find(g => g.id === groupId);
            if (selectedGroup) {
                currentSelectedGroupName = selectedGroup.groupName;
                currentStudentsInGroup = selectedGroup.students;
                currentStudentIndex = 0;

                if(currentGroupNameSpan) currentGroupNameSpan.textContent = currentSelectedGroupName;

                if(studentSelect) studentSelect.innerHTML = '';
                if (currentStudentsInGroup.length > 0) {
                    currentStudentsInGroup.forEach((student, index) => {
                        const option = document.createElement('option');
                        option.value = index;
                        option.textContent = student;
                        if(studentSelect) studentSelect.appendChild(option);
                    });
                    if(studentSelectContainer) studentSelectContainer.classList.remove('hidden');
                    if(noStudentsInGroupMessage) noStudentsInGroupMessage.classList.add('hidden');
                    loadStudentForEvaluation(currentStudentIndex);
                } else {
                    if(studentSelectContainer) studentSelectContainer.classList.add('hidden');
                    if(noStudentsInGroupMessage) noStudentsInGroupMessage.classList.remove('hidden');
                    showMessage('El grupo seleccionado no tiene estudiantes.', 'info');
                    if(studentRubricEvaluationDiv) studentRubricEvaluationDiv.innerHTML = '<p class="text-center text-gray-500">Carga un grupo con estudiantes para comenzar a evaluar.</p>';
                    if(currentStudentNameSpan) currentStudentNameSpan.textContent = 'N/A';
                    updateNavigationButtons();
                }
                showMessage(`Grupo "${currentSelectedGroupName}" cargado.`, 'success');
            } else {
                showMessage('Grupo no encontrado.', 'error');
            }
        }

        /**
         * Elimina un grupo de estudiantes de localStorage.
         * Esta función ahora trabaja con allStudentGroups.
         * @param {string} groupId - El ID del grupo a eliminar.
         */
        function deleteStudentGroup(groupId) {
            const groupToDelete = allStudentGroups.find(g => g.id === groupId);
            if (!groupToDelete) {
                showMessage('Grupo no encontrado para eliminar.', 'error');
                return;
            }

            allStudentGroups = allStudentGroups.filter(g => g.id !== groupId);
            saveToLocalStorage('allStudentGroups', allStudentGroups); // Guardar lista actualizada

            if (evaluations[groupToDelete.groupName]) {
                delete evaluations[groupToDelete.groupName];
                saveToLocalStorage('evaluations', evaluations);
            }

            showMessage('Grupo eliminado con éxito.', 'success');
            renderAllStudentGroups(); // Re-renderizar la lista de grupos

            if (currentSelectedGroupName === groupToDelete.groupName) {
                currentSelectedGroupName = '';
                currentStudentsInGroup = [];
                currentStudentIndex = -1;
                if(studentSelect) studentSelect.innerHTML = '';
                if(currentStudentNameSpan) currentStudentNameSpan.textContent = '';
                if(currentGroupNameSpan) currentGroupNameSpan.textContent = '';
                if(studentRubricEvaluationDiv) studentRubricEvaluationDiv.innerHTML = '';
                if(noStudentsInGroupMessage) noStudentsInGroupMessage.classList.remove('hidden');
                if(studentSelectContainer) studentSelectContainer.classList.add('hidden');
                updateNavigationButtons();
                updateScoreDisplays();
            }
        }

        /**
         * Guarda la evaluación de un estudiante en localStorage.
         * @param {string} studentName - Nombre del estudiante.
         * @param {string} groupName - Nombre del grupo al que pertenece el estudiante.
         * @param {object} evaluationData - Los datos completos de la evaluación para el estudiante (metadatos de rúbrica y scores).
         */
        function saveEvaluationToLocalStorage(studentName, groupName, evaluationData) {
            if (!evaluations[groupName]) {
                evaluations[groupName] = {};
            }
            evaluations[groupName][studentName] = evaluationData;
            saveToLocalStorage('evaluations', evaluations);
            console.log(`Evaluación de ${studentName} en ${groupName} guardada en localStorage.`);
        }

        /**
         * Carga la evaluación de un estudiante desde localStorage (si existe).
         * @param {string} studentName - Nombre del estudiante.
         * @param {string} groupName - Nombre del grupo.
         * @returns {object|null} La evaluación del estudiante o null si no existe.
         */
        function loadEvaluationFromLocalStorage(studentName, groupName) {
            const allEvaluations = loadFromLocalStorage('evaluations') || {};
            return allEvaluations[groupName]?.[studentName] || null;
        }

        /**
         * Actualiza el estado de los botones de navegación (anterior/siguiente estudiante).
         */
        function updateNavigationButtons() {
            if(prevStudentBtn) prevStudentBtn.disabled = currentStudentIndex <= 0;
            if(nextStudentBtn) nextStudentBtn.disabled = currentStudentIndex >= currentStudentsInGroup.length - 1;
        }

        /**
         * Calcula y actualiza los displays de puntaje total y promedio.
         * @param {string} studentName - El nombre del estudiante actual.
         * @param {string} groupName - El nombre del grupo actual.
         */
        function updateScoreDisplays() {
            const studentName = currentStudentsInGroup[currentStudentIndex];
            // Asegurarse de cargar la evaluación más reciente para el estudiante y grupo actuales
            const currentStudentEvaluation = loadEvaluationFromLocalStorage(studentName, currentSelectedGroupName);

            let totalScore = 0;
            if (currentStudentEvaluation && currentStudentEvaluation.scores) {
                Object.values(currentStudentEvaluation.scores).forEach(scoreItem => {
                    if (typeof scoreItem.score === 'number') {
                        totalScore += scoreItem.score;
                    }
                });
            }

            const numberOfAspects = rubricTemplate.length > 1 ? rubricTemplate.length - 1 : 0;
            const averageScore = numberOfAspects > 0 ? (totalScore / numberOfAspects).toFixed(2) : '0.00';

            if(totalScoreDisplay) totalScoreDisplay.textContent = totalScore;
            if(averageScoreDisplay) averageScoreDisplay.textContent = averageScore;
        }

        /**
         * Carga la rúbrica para que el estudiante seleccionado sea evaluado.
         * @param {number} index - El índice del estudiante en el array `currentStudentsInGroup`.
         */
        async function loadStudentForEvaluation(index) {
            if (index < 0 || index >= currentStudentsInGroup.length) {
                updateScoreDisplays();
                return;
            }

            currentStudentIndex = index;
            const studentName = currentStudentsInGroup[currentStudentIndex];
            if(currentStudentNameSpan) currentStudentNameSpan.textContent = studentName;

            renderRubricTable(rubricTemplate, studentRubricEvaluationDiv, false, true);

            const loadedEvaluation = loadEvaluationFromLocalStorage(studentName, currentSelectedGroupName);

            if (loadedEvaluation) {
                if (!evaluations[currentSelectedGroupName]) {
                    evaluations[currentSelectedGroupName] = {};
                }
                evaluations[currentSelectedGroupName][studentName] = loadedEvaluation;

                const studentEvaluationScores = loadedEvaluation.scores;
                if(studentRubricEvaluationDiv){
                    const tableRows = studentRubricEvaluationDiv.querySelectorAll('tbody tr');
                    tableRows.forEach((row, rowIndex) => {
                        const aspect = rubricTemplate[rowIndex + 1]?.[0];

                        if (aspect && studentEvaluationScores[aspect]) {
                            const selectedScore = studentEvaluationScores[aspect].score;
                            const scoreCells = row.querySelectorAll('.rubric-score-cell');
                            scoreCells.forEach((cell, cellIndex) => {
                                const scoreHeader = rubricTemplate[0]?.[cellIndex + 1];
                                if (scoreHeader) {
                                    const scoreMatch = scoreHeader.match(/\((\d+)\)/);
                                    const score = scoreMatch ? parseInt(scoreMatch[1], 10) : 0;
                                    if (score === selectedScore) {
                                        cell.classList.add('selected');
                                    }
                                }
                            });
                        }
                    });
                }

            } else {
                 if(studentRubricEvaluationDiv){
                    studentRubricEvaluationDiv.querySelectorAll('.rubric-score-cell').forEach(cell => {
                        cell.classList.remove('selected');
                    });
                 }

                if (!evaluations[currentSelectedGroupName]) {
                    evaluations[currentSelectedGroupName] = {};
                }
                if (!evaluations[currentSelectedGroupName][studentName]) {
                    evaluations[currentSelectedGroupName][studentName] = {
                        rubricMetadata: { ...rubricMetadata },
                        scores: {}
                    };
                }
            }
            updateNavigationButtons();
            updateScoreDisplays();
            if(studentSelect) studentSelect.value = currentStudentIndex;
        }

        // DOMContentLoaded para asegurar que todos los elementos HTML estén cargados
        document.addEventListener('DOMContentLoaded', () => {
            // Asignar referencias a los elementos del DOM
            rubricInput = document.getElementById('rubricInput');
            loadRubricBtn = document.getElementById('loadRubricBtn');
            rubricDisplay = document.getElementById('rubricDisplay');
            institutionSelect = document.getElementById('institutionSelect');
            newInstitutionInput = document.getElementById('newInstitutionInput');
            addInstitutionBtn = document.getElementById('addInstitutionBtn');
            courseSelect = document.getElementById('courseSelect');
            newCourseInput = document.getElementById('newCourseInput');
            addCourseBtn = document.getElementById('addCourseBtn');
            teacherSelect = document.getElementById('teacherSelect');
            newTeacherInput = document.getElementById('newTeacherInput');
            addTeacherBtn = document.getElementById('addTeacherBtn');
            sessionTitleInput = document.getElementById('sessionTitleInput');
            dateInput = document.getElementById('dateInput');

            groupNameInput = document.getElementById('groupNameInput');
            studentsInput = document.getElementById('studentsInput');
            saveStudentGroupBtn = document.getElementById('saveStudentGroupBtn');
            studentGroupsListContainer = document.getElementById('studentGroupsListContainer'); // Nuevo ID
            noGroupsMessage = document.getElementById('noGroupsMessage'); // Mensaje dentro del nuevo contenedor

            currentStudentNameSpan = document.getElementById('currentStudentName');
            currentGroupNameSpan = document.getElementById('currentGroupName');
            studentSelectContainer = document.getElementById('studentSelectContainer');
            studentSelect = document.getElementById('studentSelect');
            noStudentsInGroupMessage = document.getElementById('noStudentsInGroupMessage');
            studentRubricEvaluationDiv = document.getElementById('studentRubricEvaluation');
            prevStudentBtn = document.getElementById('prevStudentBtn');
            nextStudentBtn = document.getElementById('nextStudentBtn');
            totalScoreDisplay = document.getElementById('totalScoreDisplay');
            averageScoreDisplay = document.getElementById('averageScoreDisplay');

            exportRubricsBtn = document.getElementById('exportRubricsBtn');
            messageArea = document.getElementById('messageArea');

            navButtons = document.querySelectorAll('.nav-button');
            screens = document.querySelectorAll('.screen');

            // Cargar todos los datos persistentes desde localStorage al iniciar
            loadPersistentData();

            // Inicializar la aplicación: mostrar la primera pantalla por defecto
            showScreen('rubricScreen');

            // Configurar los listeners para los botones de navegación
            navButtons.forEach(button => {
                button.addEventListener('click', (event) => {
                    const screenId = event.target.dataset.screen;
                    showScreen(screenId);
                });
            });

            // Event listeners para los metadatos de la rúbrica
            if(institutionSelect) institutionSelect.addEventListener('change', updateRubricMetadata);
            if(courseSelect) courseSelect.addEventListener('change', updateRubricMetadata);
            if(teacherSelect) teacherSelect.addEventListener('change', updateRubricMetadata);
            if(sessionTitleInput) sessionTitleInput.addEventListener('input', updateRubricMetadata);
            if(dateInput) dateInput.addEventListener('change', updateRubricMetadata);

            // Add Persistent List Event Listeners
            if(addInstitutionBtn) addInstitutionBtn.addEventListener('click', () => addPersistentItem('persistentInstitutions', persistentInstitutions, newInstitutionInput, institutionSelect));
            if(addCourseBtn) addCourseBtn.addEventListener('click', () => addPersistentItem('persistentCourses', persistentCourses, newCourseInput, courseSelect));
            if(addTeacherBtn) addTeacherBtn.addEventListener('click', () => addPersistentItem('persistentTeachers', persistentTeachers, newTeacherInput, teacherSelect));

            // Cargar rúbrica
            if(loadRubricBtn) loadRubricBtn.addEventListener('click', loadRubricBtnHandler);

            // Guardar grupo de estudiantes
            if(saveStudentGroupBtn) saveStudentGroupBtn.addEventListener('click', () => {
                const groupName = groupNameInput.value.trim();
                const studentsText = studentsInput.value.trim();
                const studentsArray = studentsText.split('\n').map(s => s.trim()).filter(s => s !== '');

                if (!groupName) {
                    showMessage('Por favor, ingresa un nombre para el grupo.', 'error');
                    return;
                }
                if (studentsArray.length === 0) {
                    showMessage('Por favor, ingresa al menos un estudiante.', 'error');
                    return;
                }

                const groupId = Date.now().toString(); 

                const existingGroupIndex = allStudentGroups.findIndex(g => g.groupName === groupName);

                if (existingGroupIndex !== -1) {
                    allStudentGroups[existingGroupIndex].students = studentsArray;
                    showMessage(`Grupo "${groupName}" actualizado.`, 'success');
                } else {
                    allStudentGroups.push({ id: groupId, groupName: groupName, students: studentsArray });
                    showMessage(`Grupo "${groupName}" guardado.`, 'success');
                }
                
                saveToLocalStorage('allStudentGroups', allStudentGroups);
                groupNameInput.value = '';
                studentsInput.value = '';
                renderAllStudentGroups(); 
                showScreen('listGroupsScreen'); 
            });

            // Selector de estudiantes en pantalla de evaluación
            if(studentSelect) studentSelect.addEventListener('change', (event) => {
                const selectedIndex = parseInt(event.target.value, 10);
                loadStudentForEvaluation(selectedIndex);
            });

            // Botones de navegación de estudiante (Anterior/Siguiente)
            if(prevStudentBtn) prevStudentBtn.addEventListener('click', () => {
                if (currentStudentIndex > 0) {
                    loadStudentForEvaluation(currentStudentIndex - 1);
                }
            });

            if(nextStudentBtn) nextStudentBtn.addEventListener('click', () => {
                if (currentStudentIndex < currentStudentsInGroup.length - 1) {
                    loadStudentForEvaluation(currentStudentIndex + 1);
                }
            });

            // Botón de exportar
            if(exportRubricsBtn) exportRubricsBtn.addEventListener('click', async () => {
                if (!currentSelectedGroupName || currentStudentsInGroup.length === 0) {
                    showMessage('Por favor, selecciona un grupo de estudiantes primero.', 'error');
                    return;
                }
                
                const doc = new jsPDF();
                const headers = rubricTemplate[0];

                let firstPage = true;
                for (const studentName of currentStudentsInGroup) {
                    const studentEvaluationData = loadEvaluationFromLocalStorage(studentName, currentSelectedGroupName);

                    if (!studentEvaluationData || Object.keys(studentEvaluationData.scores || {}).length === 0) {
                        continue;
                    }

                    if (!firstPage) {
                        doc.addPage();
                    }
                    firstPage = false;

                    const meta = rubricMetadata; 
                    let totalScore = 0;
                    Object.values(studentEvaluationData.scores).forEach(scoreItem => {
                        if (typeof scoreItem.score === 'number') {
                            totalScore += scoreItem.score;
                        }
                    });

                    const numberOfAspects = rubricTemplate.length > 1 ? rubricTemplate.length - 1 : 0;
                    const averageScore = numberOfAspects > 0 ? (totalScore / numberOfAspects).toFixed(2) : '0.00';


                    doc.setFontSize(18);
                    doc.text(`Rúbrica para: ${studentName}`, 14, 20);
                    doc.setFontSize(10);
                    doc.text(`Grupo: ${currentSelectedGroupName}`, 14, 28);
                    doc.text(`Institución: ${meta.institution || 'N/A'}`, 14, 34);
                    doc.text(`Curso/Módulo: ${meta.course || 'N/A'}`, 14, 40);
                    doc.text(`Docente: ${meta.teacher || 'N/A'}`, 14, 46);
                    doc.text(`Título de Sesión: ${meta.sessionTitle || 'N/A'}`, 14, 52);
                    doc.text(`Fecha: ${meta.date || 'N/A'}`, 14, 58);
                    doc.text(`Puntaje Total: ${totalScore}`, 14, 64);
                    doc.text(`Promedio: ${averageScore}`, 14, 70);


                    const tableData = [];
                    const rubricContent = rubricTemplate.slice(1);

                    rubricContent.forEach(row => {
                        const aspect = row[0];
                        const studentScores = studentEvaluationData.scores[aspect];

                        const pdfRow = [aspect];
                        for (let i = 1; i < row.length; i++) {
                            const scoreHeader = headers[i];
                            const cellDescription = row[i];
                            const scoreMatch = scoreHeader.match(/\((\d+)\)/);
                            const scoreValue = scoreMatch ? parseInt(scoreMatch[1], 10) : 0;

                            let cellText = cellDescription;
                            let cellStyle = {};

                            if (studentScores && studentScores.score === scoreValue) {
                                cellText = `[X] ${cellDescription}`;
                                cellStyle = { fillColor: [144, 205, 244] };
                            }
                            pdfRow.push({ content: cellText, styles: cellStyle });
                        }
                        tableData.push(pdfRow);
                    });

                    doc.autoTable({
                        startY: 75,
                        head: [headers.map(h => ({ content: h, styles: { fillColor: [59, 130, 246], textColor: [255, 255, 255] } }))],
                        body: tableData,
                        theme: 'grid',
                        styles: { fontSize: 8, cellPadding: 2, overflow: 'linebreak' },
                        columnStyles: {
                            0: { cellWidth: 35 },
                        },
                        margin: { top: 10, left: 14, right: 14 }
                    });

                    doc.setFontSize(10);
                    doc.text('Generado por la Herramienta de Evaluación de Rúbricas.', 14, doc.autoTable.previous.finalY + 10);
                }

                doc.save(`evaluaciones_grupo_${currentSelectedGroupName.replace(/\s+/g, '_')}.pdf`);
                showMessage(`Evaluaciones del grupo "${currentSelectedGroupName}" exportadas a PDF.`, 'success');
            });
        });
    </script>
</body>
</html>
