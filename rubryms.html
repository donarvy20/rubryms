<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evaluador de Estudiantes por Rúbrica - Rubryms</title>
    <!-- Carga de Tailwind CSS para un diseño responsivo y moderno -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Carga de Font Awesome para iconos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* Un color de fondo suave */
            display: flex;
            flex-direction: column; /* Cambiado a columna para el footer */
            justify-content: space-between; /* Para empujar el footer al final */
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            box-sizing: border-box;
        }
        .container {
            background-color: #ffffff;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            padding: 30px;
            max-width: 800px;
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 20px;
            transition: all 0.3s ease-in-out;
            margin-bottom: 20px; /* Espacio antes del footer */
        }
        textarea {
            min-height: 150px;
            resize: vertical;
        }
        /* Botones generales de la aplicación */
        button {
            transition: background-color 0.3s ease, transform 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px; /* Espacio entre icono y texto */
        }
        button:hover {
            transform: translateY(-2px);
        }
        button:active {
            transform: translateY(0);
        }
        .message-box {
            background-color: #e0f2f7;
            color: #0288d1;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            text-align: center;
            display: none; /* Oculto por defecto */
        }
        .message-box.error {
            background-color: #ffebee;
            color: #d32f2f;
        }
        .message-box.success {
            background-color: #e8f5e9;
            color: #388e3c;
        }
        input[type="date"]::-webkit-calendar-picker-indicator {
            cursor: pointer;
        }
        .input-group {
            display: flex;
            gap: 8px;
            align-items: flex-end;
        }
        .input-group label {
            flex-grow: 1;
        }
        .input-group input, .input-group select {
            flex-grow: 1;
        }
        .input-group button {
            flex-shrink: 0;
            padding: 8px 12px;
            font-size: 0.875rem;
            line-height: 1.25rem;
            margin-bottom: 0;
        }
        /* Estilo para el textarea con líneas de fondo */
        #aspects-input, #level-list-input {
            background-image: linear-gradient(to bottom, #d1d5db 1px, transparent 1px);
            background-size: 100% 1.5em; /* Ajusta la altura de la línea según el line-height del texto */
            background-position: 0 0.8em; /* Ajusta la posición de la primera línea */
            line-height: 1.5em; /* Coincide con background-size para una alineación perfecta */
            padding-top: 0.5em; /* Ajusta el padding para que el texto no se superponga con la primera línea */
        }
        /* Asegura que la tabla de descriptores no se encoja */
        #descriptors-table table {
            min-width: 700px; /* Ancho mínimo para la tabla completa */
        }
        #descriptors-table th,
        #descriptors-table td {
            width: 150px; /* Ancho fijo para las celdas de los niveles */
        }
        #descriptors-table th:first-child,
        #descriptors-table td:first-child {
            width: 120px; /* Ancho fijo para la columna de Aspectos */
        }
        #descriptors-table textarea {
            min-height: 80px; /* Altura mínima para los textareas en la tabla */
            max-height: 150px; /* Altura máxima para permitir el scroll interno */
            resize: vertical; /* Permitir redimensionar solo verticalmente */
        }

        /* Estilos para el menú de navegación */
        .nav-bar {
            background-color: #e2e8f0; /* Color de fondo del menú */
            padding: 10px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            position: relative; /* Para el posicionamiento absoluto del menú móvil */
        }
        .nav-item {
            background-color: transparent;
            color: #4a5568; /* Color de texto normal */
            font-weight: 600;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
            flex-grow: 1; /* Para distribuir el espacio uniformemente en desktop */
            margin: 0 5px; /* Pequeño margen entre botones */
            width: auto; /* Allow content width */
        }
        /* Estilos para elementos de navegación en modo móvil (columna completa) */
        #nav-links-container.flex-col .nav-item {
            width: 100%; /* Ocupar todo el ancho en móvil */
            margin: 5px 0; /* Margen vertical para elementos de menú móvil */
            text-align: center;
        }

        .nav-item:hover {
            background-color: #cbd5e0; /* Color al pasar el ratón */
            color: #2d3748;
        }
        .nav-item.active {
            background-color: #6366f1; /* Color de la pestaña activa (indigo-500) */
            color: white;
            box-shadow: 0 4px 10px rgba(99, 102, 241, 0.3);
            transform: translateY(-2px); /* Un ligero efecto de elevación */
        }

        /* Estilos para las tarjetas de grupo */
        .group-card {
            background-color: #f8fafc; /* light blue-grey */
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
            gap: 10px;
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            border: 2px solid transparent; /* Para el borde activo */
        }
        .group-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .group-card.active {
            border-color: #6366f1; /* indigo-500 */
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
            background-color: #e0e7ff; /* indigo-100 */
        }
        .group-card .group-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
            margin-top: 10px;
        }
        .group-card .group-actions button {
            padding: 6px 12px;
            font-size: 0.875rem;
            border-radius: 6px;
            box-shadow: none;
            transform: none;
            background-color: #cbd5e0; /* gray-300 */
            color: #4a5568; /* gray-700 */
        }
        .group-card .group-actions button:hover {
            background-color: #a0aec0; /* gray-400 */
            transform: none;
        }

        /* Media queries para el menú responsivo */
        @media (max-width: 767px) { /* Hasta 767px (móviles) */
            .nav-bar {
                flex-direction: column;
                align-items: flex-start;
            }
            #nav-links-container {
                position: absolute;
                top: 100%;
                left: 0;
                width: 100%;
                background-color: #e2e8f0;
                border-radius: 0 0 10px 10px;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
                z-index: 10;
            }
            #nav-links-container.flex-col {
                display: flex;
            }
            .nav-item {
                width: 100%;
                margin: 5px 0;
                text-align: center;
            }
        }

        @media (min-width: 768px) and (max-width: 1023px) { /* Tablets (768px a 1023px) */
            #nav-links-container {
                display: flex; /* Mostrar como flex */
                flex-direction: column; /* En columna */
                flex-grow: 1;
                justify-content: center; /* Centrar elementos verticalmente */
                gap: 0; /* Eliminar el gap horizontal */
            }
            .nav-item {
                width: auto; /* Ancho automático para los elementos */
                margin: 5px auto; /* Centrar elementos con margen automático */
            }
        }

        @media (min-width: 1024px) { /* Escritorio (1024px y más) */
            #nav-links-container {
                display: flex; /* Mostrar como flex */
                flex-direction: row; /* En fila */
                flex-grow: 1;
                justify-content: flex-end; /* Alinear a la derecha */
                gap: 8px; /* Restablecer el gap */
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-3xl md:text-4xl font-bold text-center text-gray-800 mb-6 flex items-center justify-center">
            <img src="https://cdn-icons-png.flaticon.com/512/11339/11339984.png" alt="Rubryms Icon" class="w-10 h-10 mr-3">
            Rubryms - Evaluador de Estudiantes
        </h1>

        <!-- Menú de Navegación -->
        <nav class="nav-bar flex items-center justify-between">
            <!-- Título o logo para pantallas pequeñas y botón de hamburguesa -->
            <div class="flex items-center justify-between w-full md:w-auto">
                <span class="text-xl font-bold text-gray-800 md:hidden">Menú</span>
                <!-- Mobile menu toggle -->
                <button id="mobile-menu-toggle" class="md:hidden p-2 text-gray-700 focus:outline-none focus:ring-2 focus:ring-indigo-300 rounded-md">
                    <i class="fas fa-bars text-2xl"></i>
                </button>
            </div>

            <!-- Contenedor de enlaces de navegación (visible en md y más grande, o cuando el menú móvil está abierto) -->
            <div id="nav-links-container" class="hidden md:flex flex-col md:flex-row flex-grow justify-end gap-2 md:gap-4 w-full md:w-auto">
                <button id="nav-students" class="nav-item active"><i class="fas fa-users mr-2"></i> Gestión de Estudiantes</button>
                <button id="nav-levels" class="nav-item"><i class="fas fa-list-ol mr-2"></i> Gestión de Niveles</button>
                <button id="nav-rubric" class="nav-item"><i class="fas fa-cogs mr-2"></i> Configuración de Rúbrica</button>
                <button id="nav-evaluation" class="nav-item"><i class="fas fa-pencil-alt mr-2"></i> Evaluación</button>
                <button id="nav-reports" class="nav-item"><i class="fas fa-file-pdf mr-2"></i> Reportes y Exportación</button>
            </div>
        </nav>

        <!-- Secciones de la Aplicación -->
        <div id="students-screen" class="bg-blue-50 p-6 rounded-xl border border-blue-200">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4 text-center">
                <i class="fas fa-users text-blue-600 mr-2"></i> 1. Agregar y Gestionar Estudiantes
            </h2>
            
            <div class="mb-4">
                <label for="group-name-input" class="block text-gray-700 font-medium mb-2">Nombre del Nuevo Grupo de Estudiantes (opcional):</label>
                <input
                    type="text"
                    id="group-name-input"
                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-200"
                    placeholder="Ej: Grupo A, Ciencias Sociales"
                />
            </div>

            <p class="text-gray-600 mb-2 text-center">Pega aquí la lista de nombres de tus estudiantes (uno por línea).</p>
            <textarea
                id="student-list-input"
                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-200"
                placeholder="Ejemplo:&#10;Juan Pérez&#10;María García&#10;Carlos López"
            ></textarea>
            <button
                id="add-students-btn"
                class="w-full bg-blue-600 text-white font-semibold py-3 px-6 mt-4 rounded-xl shadow-md hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-300"
            >
                <i class="fas fa-save"></i> Guardar Lista de Estudiantes
            </button>
            <div id="student-message-box" class="message-box"></div>

            <div class="mt-6 border-t pt-4 border-gray-200">
                <h3 class="text-xl font-semibold text-gray-700 mb-4 text-center">Seleccionar Grupo para Evaluación</h3>
                <p class="text-gray-600 mb-4 text-center">Haz clic en una tarjeta para cargar o editar un grupo:</p>
                <div id="group-cards-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- Las tarjetas de grupo se renderizarán aquí -->
                </div>
                <!-- Los botones Cargar y Eliminar ya no son necesarios aquí directamente si están en las tarjetas
                <button
                    id="select-group-from-cards-btn"
                    class="w-full bg-indigo-600 text-white font-semibold py-3 px-6 mt-4 rounded-xl shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-4 focus:ring-indigo-300 hidden"
                >
                    <i class="fas fa-folder-open"></i> Cargar Grupo Seleccionado y Continuar
                </button>
                <button
                    id="delete-group-from-cards-btn"
                    class="w-full bg-red-500 text-white font-semibold py-3 px-6 mt-2 rounded-xl shadow-md hover:bg-red-600 focus:outline-none focus:ring-4 focus:ring-red-300 hidden"
                >
                    <i class="fas fa-trash-alt"></i> Eliminar Grupo Seleccionado
                </button>
                -->
            </div>
        </div>

        <!-- Nuevo módulo de Gestión de Niveles de Desempeño -->
        <div id="level-management-screen" class="bg-purple-50 p-6 rounded-xl border border-purple-200 hidden">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4 text-center">
                <i class="fas fa-list-ol text-purple-600 mr-2"></i> Gestión de Niveles de Desempeño
            </h2>
            <p class="text-gray-600 mb-4 text-center">Crea y gestiona tus grupos de niveles de desempeño.</p>

            <div class="mb-4">
                <label for="level-group-name-input" class="block text-gray-700 font-medium mb-2">Nombre del Grupo de Niveles:</label>
                <input
                    type="text"
                    id="level-group-name-input"
                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500 transition duration-200"
                    placeholder="Ej: Cualitativo, Escala Numérica"
                />
            </div>

            <p class="text-gray-600 mb-2 text-center">Pega aquí los niveles de desempeño (uno por línea).</p>
            <textarea
                id="level-list-input"
                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500 transition duration-200"
                placeholder="Ejemplo:&#10;Destacado&#10;Logrado&#10;En Proceso&#10;En Inicio"
            ></textarea>
            <button
                id="save-level-group-btn"
                class="w-full bg-purple-600 text-white font-semibold py-3 px-6 mt-4 rounded-xl shadow-md hover:bg-purple-700 focus:outline-none focus:ring-4 focus:ring-purple-300"
            >
                <i class="fas fa-save"></i> Guardar Grupo de Niveles
            </button>
            <div id="level-management-message-box" class="message-box"></div>

            <div class="mt-6 border-t pt-4 border-gray-200">
                <h3 class="text-xl font-semibold text-gray-700 mb-4 text-center">Seleccionar Grupo de Niveles</h3>
                <p class="text-gray-600 mb-2 text-center">O elige un grupo existente para editar o usar:</p>
                <select id="level-group-select-for-management" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500 transition duration-200">
                    <option value="">-- Seleccionar Grupo de Niveles --</option>
                </select>
                <button
                    id="load-level-group-btn"
                    class="w-full bg-indigo-600 text-white font-semibold py-3 px-6 mt-4 rounded-xl shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-4 focus:ring-indigo-300"
                >
                    <i class="fas fa-edit"></i> Cargar Grupo para Editar
                </button>
                <button
                    id="delete-level-group-btn"
                    class="w-full bg-red-500 text-white font-semibold py-3 px-6 mt-2 rounded-xl shadow-md hover:bg-red-600 focus:outline-none focus:ring-4 focus:ring-red-300"
                >
                    <i class="fas fa-trash-alt"></i> Eliminar Grupo Seleccionado
                </button>
            </div>
        </div>

        <div id="rubric-config-screen" class="bg-green-50 p-6 rounded-xl border border-green-200 hidden">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4 text-center">
                <i class="fas fa-cogs text-green-600 mr-2"></i> 2. Configuración de la Rúbrica
            </h2>
            <p class="text-gray-600 mb-4 text-center">Define los detalles de la sesión, aspectos a evaluar y el grupo de niveles de desempeño a utilizar.</p>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <div class="input-group flex-col md:flex-row">
                    <label for="institution-select" class="block text-gray-700 font-medium mb-2 md:mb-0">Institución Educativa:</label>
                    <select id="institution-select" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500">
                        <option value="">-- Seleccionar o Añadir --</option>
                    </select>
                    <input type="text" id="new-institution-input" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500 hidden" placeholder="Añadir nueva institución">
                    <button id="add-institution-btn" class="bg-green-500 text-white rounded-md hover:bg-green-600"><i class="fas fa-plus"></i></button>
                    <button id="toggle-institution-input" class="bg-gray-400 text-white rounded-md hover:bg-gray-500"><i class="fas fa-exchange-alt"></i></button>
                </div>
                <div class="input-group flex-col md:flex-row">
                    <label for="course-select" class="block text-gray-700 font-medium mb-2 md:mb-0">Curso/Módulo:</label>
                    <select id="course-select" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500">
                        <option value="">-- Seleccionar o Añadir --</option>
                    </select>
                    <input type="text" id="new-course-input" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500 hidden" placeholder="Añadir nuevo curso">
                    <button id="add-course-btn" class="bg-green-500 text-white rounded-md hover:bg-green-600"><i class="fas fa-plus"></i></button>
                    <button id="toggle-course-input" class="bg-gray-400 text-white rounded-md hover:bg-gray-500"><i class="fas fa-exchange-alt"></i></button>
                </div>
                <div class="input-group flex-col md:flex-row">
                    <label for="teacher-select" class="block text-gray-700 font-medium mb-2 md:mb-0">Docente:</label>
                    <select id="teacher-select" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500">
                        <option value="">-- Seleccionar o Añadir --</option>
                    </select>
                    <input type="text" id="new-teacher-input" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500 hidden" placeholder="Añadir nuevo docente">
                    <button id="add-teacher-btn" class="bg-green-500 text-white rounded-md hover:bg-green-600"><i class="fas fa-plus"></i></button>
                    <button id="toggle-teacher-input" class="bg-gray-400 text-white rounded-md hover:bg-gray-500"><i class="fas fa-exchange-alt"></i></button>
                </div>
                <div class="col-span-full">
                    <label for="session-title-input" class="block text-gray-700 font-medium mb-2">Título de la sesión:</label>
                    <input type="text" id="session-title-input" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500" placeholder="Ej: Presentación Final de Proyecto">
                </div>
                <div class="col-span-full">
                    <label for="date-input" class="block text-gray-700 font-medium mb-2">Fecha:</label>
                    <input type="date" id="date-input" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500">
                </div>
            </div>

            <div class="mb-6">
                <label for="aspects-input" class="block text-gray-700 font-medium mb-2">Aspectos a Evaluar (uno por línea):</label>
                <textarea
                    id="aspects-input"
                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500 transition duration-200"
                    placeholder="Ejemplo:&#10;Coherencia&#10;Claridad&#10;Uso de la gramática"
                >Coherencia
Claridad
Uso de la gramática</textarea>
            </div>

            <!-- Selector de Grupos de Niveles para la Rúbrica -->
            <div class="mb-6">
                <label for="rubric-levels-group-select" class="block text-gray-700 font-medium mb-2">Seleccionar Grupo de Niveles de Desempeño:</label>
                <select id="rubric-levels-group-select" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500">
                    <option value="">-- Seleccionar Grupo de Niveles --</option>
                </select>
            </div>
            
            <button
                id="generate-rubric-btn"
                class="w-full bg-green-600 text-white font-semibold py-3 px-6 rounded-xl shadow-md hover:bg-green-700 focus:outline-none focus:ring-4 focus:ring-green-300"
            >
                <i class="fas fa-magic"></i> Generar Rúbrica
            </button>
            <div id="rubric-config-message-box" class="message-box"></div>

            <div id="rubric-descriptors-editor" class="mt-8 hidden">
                <h3 class="text-xl font-semibold text-gray-700 mb-4">Asignar Puntajes por Nivel</h3>
                <p class="text-gray-600 mb-4">Define el puntaje máximo para cada nivel de desempeño.</p>
                <div id="level-scores-input-area" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                    </div>

                <h3 class="text-xl font-semibold text-gray-700 mb-4">Descriptores de la Rúbrica</h3>
                <p class="text-gray-600 mb-4">Edita los descriptores para cada aspecto y nivel.</p>
                <div id="descriptors-table" class="overflow-x-auto"> <!-- Contenedor para scroll horizontal si es necesario -->
                    </div>

                <div class="mt-6">
                    <label for="general-observations-input" class="block text-gray-700 font-medium mb-2">Observaciones Generales de la Rúbrica:</label>
                    <textarea
                        id="general-observations-input"
                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500 transition duration-200"
                        rows="4"
                        placeholder="Cualquier observación adicional sobre la rúbrica general."
                    ></textarea>
                </div>

                <button
                    id="save-rubric-btn"
                    class="w-full bg-purple-600 text-white font-semibold py-3 px-6 mt-6 rounded-xl shadow-md hover:bg-purple-700 focus:outline-none focus:ring-4 focus:ring-purple-300"
                >
                    <i class="fas fa-save"></i> Guardar Rúbrica y Empezar Evaluación
                </button>
            </div>
        </div>

        <div id="evaluation-screen" class="bg-yellow-50 p-6 rounded-xl border border-yellow-200 hidden">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4 text-center">
                <i class="fas fa-pencil-alt text-yellow-600 mr-2"></i> 3. Evaluación de Estudiantes
            </h2>
            <div class="text-center mb-4">
                <p class="text-lg text-gray-800 font-semibold">Estudiante Actual: <span id="current-student-name" class="text-blue-600"></span></p>
                <p class="text-gray-600 text-sm">Estudiante <span id="student-index">1</span> de <span id="total-students">0</span></p>
            </div>
            <div id="student-rubric-display" class="overflow-x-auto">
                </div>
            <div class="flex flex-col sm:flex-row justify-center gap-4 mt-6">
                <button
                    id="prev-student-btn"
                    class="flex-1 bg-gray-400 text-white font-semibold py-3 px-6 rounded-xl shadow-md hover:bg-gray-500 focus:outline-none focus:ring-4 focus:ring-gray-300"
                >
                    <i class="fas fa-arrow-left"></i> Anterior
                </button>
                <button
                    id="next-student-btn"
                    class="flex-1 bg-blue-600 text-white font-semibold py-3 px-6 rounded-xl shadow-md hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-300"
                >
                    Siguiente Estudiante <i class="fas fa-arrow-right"></i>
                </button>
                <button
                    id="finish-evaluation-btn"
                    class="flex-1 bg-indigo-600 text-white font-semibold py-3 px-6 rounded-xl shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-4 focus:ring-indigo-300 hidden"
                >
                    <i class="fas fa-check-circle"></i> Finalizar Evaluación y Exportar
                </button>
            </div>
            <div id="evaluation-message-box" class="message-box"></div>
        </div>

        <div id="report-screen" class="bg-red-50 p-6 rounded-xl border border-red-200 hidden">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4 text-center">
                <i class="fas fa-file-pdf text-red-600 mr-2"></i> 4. Reporte y Exportación a PDF
            </h2>
            <p class="text-gray-600 mb-4 text-center">Haz clic para generar el reporte de todas las evaluaciones.</p>
            <div class="flex flex-col sm:flex-row justify-center gap-4 mt-6">
                <button
                    id="export-pdf-btn"
                    class="flex-1 bg-red-600 text-white font-semibold py-3 px-6 rounded-xl shadow-md hover:bg-red-700 focus:outline-none focus:ring-4 focus:ring-red-300"
                >
                    <i class="fas fa-file-alt"></i> Exportar Reporte General a PDF
                </button>
                <button
                    id="export-individual-rubrics-btn"
                    class="flex-1 bg-teal-600 text-white font-semibold py-3 px-6 rounded-xl shadow-md hover:bg-teal-700 focus:outline-none focus:ring-4 focus:ring-teal-300"
                >
                    <i class="fas fa-file-export"></i> Exportar Rúbricas Individuales a PDF
                </button>
            </div>
            <div class="flex flex-col sm:flex-row justify-center gap-4 mt-4">
                <button
                    id="back-to-evaluation-btn"
                    class="flex-1 bg-gray-600 text-white font-semibold py-3 px-6 rounded-xl shadow-md hover:bg-gray-700 focus:outline-none focus:ring-4 focus:ring-gray-300"
                >
                    <i class="fas fa-undo"></i> Atrás (Modificar Evaluación)
                </button>
                <button
                    id="new-rubric-btn"
                    class="flex-1 bg-blue-600 text-white font-semibold py-3 px-6 rounded-xl shadow-md hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-300"
                >
                    <i class="fas fa-plus-circle"></i> Nueva Rúbrica
                </button>
            </div>
            <div id="report-message-box" class="message-box"></div>
        </div>

    </div>

    <footer class="w-full text-center py-4 text-gray-600 text-sm">
        developed by YJMS
    </footer>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.14/jspdf.plugin.autotable.min.js"></script>

    <script>
        // Obtener referencias a los elementos del DOM
        const navStudentsBtn = document.getElementById('nav-students');
        const navLevelsBtn = document.getElementById('nav-levels'); 
        const navRubricBtn = document.getElementById('nav-rubric');
        const navEvaluationBtn = document.getElementById('nav-evaluation');
        const navReportsBtn = document.getElementById('nav-reports');

        const studentsScreen = document.getElementById('students-screen');
        const levelManagementScreen = document.getElementById('level-management-screen'); 
        const rubricConfigScreen = document.getElementById('rubric-config-screen');
        const evaluationScreen = document.getElementById('evaluation-screen');
        const reportScreen = document.getElementById('report-screen');

        // Referencias para el menú móvil
        const mobileMenuToggle = document.getElementById('mobile-menu-toggle');
        const navLinksContainer = document.getElementById('nav-links-container');


        const groupNameInput = document.getElementById('group-name-input');
        const studentListInput = document.getElementById('student-list-input');
        const addStudentsBtn = document.getElementById('add-students-btn');
        const groupCardsContainer = document.getElementById('group-cards-container'); 
        const studentMessageBox = document.getElementById('student-message-box');

        // Referencias para el nuevo módulo de gestión de niveles
        const levelGroupNameInput = document.getElementById('level-group-name-input');
        const levelListInput = document.getElementById('level-list-input');
        const saveLevelGroupBtn = document.getElementById('save-level-group-btn');
        const levelGroupSelectForManagement = document.getElementById('level-group-select-for-management');
        const loadLevelGroupBtn = document.getElementById('load-level-group-btn');
        const deleteLevelGroupBtn = document.getElementById('delete-level-group-btn');
        const levelManagementMessageBox = document.getElementById('level-management-message-box');

        const institutionSelect = document.getElementById('institution-select');
        const newInstitutionInput = document.getElementById('new-institution-input');
        const addInstitutionBtn = document.getElementById('add-institution-btn');
        const toggleInstitutionInput = document.getElementById('toggle-institution-input');
        const courseSelect = document.getElementById('course-select');
        const newCourseInput = document.getElementById('new-course-input');
        const addCourseBtn = document.getElementById('add-course-btn');
        const toggleCourseInput = document.getElementById('toggle-course-input');
        const teacherSelect = document.getElementById('teacher-select');
        const newTeacherInput = document.getElementById('new-teacher-input');
        const addTeacherBtn = document.getElementById('add-teacher-btn');
        const toggleTeacherInput = document.getElementById('toggle-teacher-input');
        const sessionTitleInput = document.getElementById('session-title-input');
        const dateInput = document.getElementById('date-input');
        const aspectsInput = document.getElementById('aspects-input');
        const rubricLevelsGroupSelect = document.getElementById('rubric-levels-group-select'); 
        const generateRubricBtn = document.getElementById('generate-rubric-btn');
        const rubricConfigMessageBox = document.getElementById('rubric-config-message-box');
        const rubricDescriptorsEditor = document.getElementById('rubric-descriptors-editor');
        const levelScoresInputArea = document.getElementById('level-scores-input-area');
        const descriptorsTable = document.getElementById('descriptors-table');
        const generalObservationsInput = document.getElementById('general-observations-input');
        const saveRubricBtn = document.getElementById('save-rubric-btn');

        const currentStudentName = document.getElementById('current-student-name');
        const studentIndexSpan = document.getElementById('student-index');
        const totalStudentsSpan = document.getElementById('total-students');
        const studentRubricDisplay = document.getElementById('student-rubric-display');
        const prevStudentBtn = document.getElementById('prev-student-btn');
        const nextStudentBtn = document.getElementById('next-student-btn');
        const finishEvaluationBtn = document.getElementById('finish-evaluation-btn');
        const evaluationMessageBox = document.getElementById('evaluation-message-box');

        const exportPdfBtn = document.getElementById('export-pdf-btn');
        const exportIndividualRubricsBtn = document.getElementById('export-individual-rubrics-btn');
        const backToEvaluationBtn = document.getElementById('back-to-evaluation-btn');
        const newRubricBtn = document.getElementById('new-rubric-btn');
        const reportMessageBox = document.getElementById('report-message-box');

        // Variables globales para la aplicación
        let studentGroups = {}; // { 'Group Name': ['Student 1', 'Student 2'], ... }
        let savedLevelGroups = {}; // { 'Group Name': ['Level 1', 'Level 2'], ... }
        let currentStudents = []; // The currently selected group of students for evaluation
        let currentSelectedGroupName = ''; // Variable para almacenar el nombre del grupo seleccionado
        let currentStudentIndex = 0;
        let savedInstitutions = [];
        let savedCourses = [];
        let savedTeachers = [];
        
        let rubric = {
            institution: '',
            course: '',
            sessionTitle: '',
            teacher: '',
            date: '',
            generalObservations: '',
            aspects: [],
            selectedLevelGroupName: '', 
            levels: [], 
            descriptors: {}, 
            levelScores: {} 
        };
        let evaluations = {}; // { 'GroupName_StudentName': { aspect: level_selected, ... }, ... }

        // Colores de tarjetas predefinidos para rotación
        const cardColors = [
            'bg-blue-100 border-blue-300',
            'bg-green-100 border-green-300',
            'bg-purple-100 border-purple-300',
            'bg-yellow-100 border-yellow-300',
            'bg-teal-100 border-teal-300',
            'bg-red-100 border-red-300',
        ];
        let colorIndex = 0; // Para rotar los colores de las tarjetas

        // --- Funciones de Utilidad ---

        /**
         * Muestra un mensaje en una caja de mensajes específica.
         * @param {HTMLElement} boxElement - El elemento DOM de la caja de mensajes.
         * @param {string} message - El texto del mensaje.
         * @param {string} type - 'success', 'error', o vacío para información.
         */
        function showMessage(boxElement, message, type = '') {
            boxElement.textContent = message;
            boxElement.className = 'message-box'; // Restablece clases
            if (type) {
                boxElement.classList.add(type);
            }
            boxElement.style.display = 'block';
            setTimeout(() => {
                boxElement.style.display = 'none';
            }, 5000); // El mensaje desaparece después de 5 segundos
        }

        /**
         * Maneja la navegación entre pantallas.
         * @param {string} screenId - El ID de la pantalla a mostrar.
         */
        function showScreen(screenId) {
            // Oculta todas las pantallas
            studentsScreen.classList.add('hidden');
            levelManagementScreen.classList.add('hidden'); 
            rubricConfigScreen.classList.add('hidden');
            evaluationScreen.classList.add('hidden');
            reportScreen.classList.add('hidden');

            // Quita la clase 'active' de todos los botones de navegación
            navStudentsBtn.classList.remove('active');
            navLevelsBtn.classList.remove('active'); 
            navRubricBtn.classList.remove('active');
            navEvaluationBtn.classList.remove('active');
            navReportsBtn.classList.remove('active');

            // Muestra la pantalla deseada y activa el botón de navegación correspondiente
            if (screenId === 'students-screen') {
                studentsScreen.classList.remove('hidden');
                navStudentsBtn.classList.add('active');
            } else if (screenId === 'level-management-screen') { 
                levelManagementScreen.classList.remove('hidden');
                navLevelsBtn.classList.add('active');
                renderLevelGroupSelectForManagement();
            } else if (screenId === 'rubric-config-screen') {
                rubricConfigScreen.classList.remove('hidden');
                navRubricBtn.classList.add('active');
                renderRubricLevelGroupSelect();
            } else if (screenId === 'evaluation-screen') {
                evaluationScreen.classList.remove('hidden');
                navEvaluationBtn.classList.add('active');
                renderStudentEvaluation();
            } else if (screenId === 'report-screen') {
                reportScreen.classList.remove('hidden');
                navReportsBtn.classList.add('active');
            }

            // Oculta el menú móvil si está abierto después de la navegación
            if (window.innerWidth < 768 && !navLinksContainer.classList.contains('hidden')) {
                navLinksContainer.classList.add('hidden');
                navLinksContainer.classList.remove('flex', 'flex-col', 'absolute', 'top-full', 'left-0', 'w-full', 'bg-gray-200', 'p-4', 'rounded-b-xl', 'z-10');
            }
        }

        // Event listeners para la navegación
        navStudentsBtn.addEventListener('click', () => showScreen('students-screen'));
        navLevelsBtn.addEventListener('click', () => showScreen('level-management-screen'));
        navRubricBtn.addEventListener('click', () => showScreen('rubric-config-screen'));
        navEvaluationBtn.addEventListener('click', () => {
            if (currentStudents.length === 0 || rubric.aspects.length === 0 || rubric.levels.length === 0 || Object.keys(rubric.descriptors).length === 0 || Object.keys(rubric.levelScores).length === 0) {
                 showMessage(evaluationMessageBox, "Por favor, carga un grupo de estudiantes y configura la rúbrica antes de evaluar.", 'error');
                 return;
            }
            showScreen('evaluation-screen');
        });
        navReportsBtn.addEventListener('click', () => showScreen('report-screen'));

        // Lógica para el botón de menú móvil (hamburguesa)
        mobileMenuToggle.addEventListener('click', () => {
            navLinksContainer.classList.toggle('hidden');
            if (!navLinksContainer.classList.contains('hidden')) {
                navLinksContainer.classList.add('flex', 'flex-col', 'absolute', 'top-full', 'left-0', 'w-full', 'bg-gray-200', 'p-4', 'rounded-b-xl', 'z-10');
            } else {
                navLinksContainer.classList.remove('flex', 'flex-col', 'absolute', 'top-full', 'left-0', 'w-full', 'bg-gray-200', 'p-4', 'rounded-b-xl', 'z-10');
            }
        });

        // Asegura que el menú de navegación se muestre/oculte correctamente al redimensionar la ventana
        window.addEventListener('resize', () => {
            if (window.innerWidth >= 1024) { /* Usar lg breakpoint para flex-row */
                navLinksContainer.classList.remove('hidden', 'flex-col', 'absolute', 'top-full', 'left-0', 'w-full', 'bg-gray-200', 'p-4', 'rounded-b-xl', 'z-10');
                navLinksContainer.classList.add('flex', 'flex-row');
            } else if (window.innerWidth >= 768) { /* Usar md breakpoint para flex-col */
                navLinksContainer.classList.remove('hidden', 'absolute', 'top-full', 'left-0', 'w-full', 'bg-gray-200', 'p-4', 'rounded-b-xl', 'z-10', 'flex-row');
                navLinksContainer.classList.add('flex', 'flex-col');
            } else { /* Móvil */
                navLinksContainer.classList.add('hidden');
                navLinksContainer.classList.remove('flex', 'flex-col', 'absolute', 'top-full', 'left-0', 'w-full', 'bg-gray-200', 'p-4', 'rounded-b-xl', 'z-10', 'flex-row');
            }
        });


        /**
         * Carga los datos de estudiantes, rúbrica y evaluaciones desde localStorage.
         */
        function loadData() {
            try {
                const storedStudentGroups = localStorage.getItem('studentGroups');
                if (storedStudentGroups) {
                    studentGroups = JSON.parse(storedStudentGroups);
                    renderGroupCards(); // Usar la nueva función de renderizado de tarjetas
                }

                const storedLevelGroups = localStorage.getItem('savedLevelGroups'); 
                if (storedLevelGroups) {
                    savedLevelGroups = JSON.parse(storedLevelGroups);
                    // No llamamos a renderLevelGroupSelectForManagement ni renderRubricLevelGroupSelect aquí
                    // ya que showScreen() las llamará al entrar a sus respectivos módulos.
                } else {
                    // Si no hay grupos de niveles guardados, añadir un grupo por defecto
                    savedLevelGroups['Cualitativo'] = ['Destacado', 'Logrado', 'Proceso', 'Inicio', 'Previo al Inicio'];
                    savedLevelGroups['Escala'] = ['Deficiente', 'Regular', 'Bueno', 'Excelente'];
                    saveData(); 
                }

                const storedInstitutions = localStorage.getItem('savedInstitutions');
                if (storedInstitutions) {
                    savedInstitutions = JSON.parse(storedInstitutions);
                    renderDropdownOptions(institutionSelect, savedInstitutions);
                }
                const storedCourses = localStorage.getItem('savedCourses');
                if (storedCourses) {
                    savedCourses = JSON.parse(storedCourses);
                    renderDropdownOptions(courseSelect, savedCourses);
                }
                const storedTeachers = localStorage.getItem('savedTeachers');
                if (storedTeachers) {
                    savedTeachers = JSON.parse(storedTeachers);
                    renderDropdownOptions(teacherSelect, savedTeachers);
                }
                
                const storedRubric = localStorage.getItem('rubric');
                if (storedRubric) {
                    const parsedRubric = JSON.parse(storedRubric);
                    rubric = { ...rubric, ...parsedRubric };
                    
                    if (rubric.date) {
                         dateInput.value = rubric.date;
                    }
                    institutionSelect.value = rubric.institution;
                    courseSelect.value = rubric.course;
                    teacherSelect.value = rubric.teacher;

                    if (rubric.selectedLevelGroupName) {
                        rubric.levels = savedLevelGroups[rubric.selectedLevelGroupName] || [];
                    }
                }

                const storedEvaluations = localStorage.getItem('evaluations');
                if (storedEvaluations) {
                    evaluations = JSON.parse(storedEvaluations);
                }

                const storedCurrentGroup = localStorage.getItem('currentSelectedGroupName'); // Ahora es currentSelectedGroupName
                if(storedCurrentGroup && studentGroups[storedCurrentGroup]) {
                    currentStudents = studentGroups[storedCurrentGroup];
                    currentSelectedGroupName = storedCurrentGroup; // Actualizar la variable global
                    // highlightSelectedGroupCard(currentSelectedGroupName); // Ya se llama desde renderGroupCards
                }

                sessionTitleInput.value = rubric.sessionTitle;
                generalObservationsInput.value = rubric.generalObservations;
                aspectsInput.value = rubric.aspects.join('\n');
                
                showScreen('students-screen'); // Siempre inicia en la pantalla de estudiantes
            } catch (e) {
                console.error("Error al cargar datos de localStorage:", e);
                showMessage(studentMessageBox, "Error al cargar datos guardados. Los datos pueden estar corruptos.", 'error');
            }
        }

        /**
         * Guarda los datos de estudiantes, rúbrica y evaluaciones en localStorage.
         */
        function saveData() {
            try {
                localStorage.setItem('studentGroups', JSON.stringify(studentGroups));
                localStorage.setItem('savedLevelGroups', JSON.stringify(savedLevelGroups)); 
                localStorage.setItem('savedInstitutions', JSON.stringify(savedInstitutions));
                localStorage.setItem('savedCourses', JSON.stringify(savedCourses));
                localStorage.setItem('savedTeachers', JSON.stringify(savedTeachers));
                localStorage.setItem('rubric', JSON.stringify(rubric));
                localStorage.setItem('evaluations', JSON.stringify(evaluations));
                localStorage.setItem('currentSelectedGroupName', currentSelectedGroupName); // Guardar el nombre del grupo seleccionado
            } catch (e) {
                console.error("Error al guardar datos en localStorage:", e);
                showMessage(studentMessageBox, "No se pudieron guardar los datos. Verifique el espacio disponible en su navegador.", 'error');
            }
        }

        /**
         * Rellena las opciones de un dropdown con una lista de elementos.
         * @param {HTMLSelectElement} selectElement - El elemento select del DOM.
         * @param {string[]} optionsArray - Un array de cadenas para las opciones.
         * @param {string} defaultText - Texto de la opción por defecto.
         */
        function renderDropdownOptions(selectElement, optionsArray, defaultText = '-- Seleccionar o Añadir --') {
            selectElement.innerHTML = `<option value="">${defaultText}</option>`;
            optionsArray.forEach(item => {
                const option = document.createElement('option');
                option.value = item;
                option.textContent = item;
                selectElement.appendChild(option);
            });
        }

        /**
         * Resetea la RÚBRICA y las EVALUACIONES, pero mantiene los grupos de estudiantes y los datos institucionales.
         */
        function resetApp() {
            localStorage.removeItem('rubric');
            localStorage.removeItem('evaluations');

            rubric = {
                institution: '',
                course: '',
                sessionTitle: '',
                teacher: '',
                date: '',
                generalObservations: '',
                aspects: [],
                selectedLevelGroupName: '',
                levels: [],
                descriptors: {},
                levelScores: {}
            };
            evaluations = {};

            sessionTitleInput.value = '';
            dateInput.value = '';
            aspectsInput.value = 'Coherencia\nClaridad\nUso de la gramática';
            generalObservationsInput.value = '';

            institutionSelect.value = '';
            courseSelect.value = '';
            teacherSelect.value = '';
            rubricLevelsGroupSelect.value = '';

            if (newInstitutionInput) newInstitutionInput.classList.add('hidden');
            if (newInstitutionInput) newInstitutionInput.value = '';
            if (newCourseInput) newCourseInput.classList.add('hidden');
            if (newCourseInput) newCourseInput.value = '';
            if (newTeacherInput) newTeacherInput.classList.add('hidden');
            if (newTeacherInput) newTeacherInput.value = '';
            
            rubricConfigScreen.classList.add('hidden');
            levelManagementScreen.classList.add('hidden');
            evaluationScreen.classList.add('hidden');
            reportScreen.classList.add('hidden');
            rubricDescriptorsEditor.classList.add('hidden');
            
            showScreen('students-screen');
            showMessage(reportMessageBox, "La rúbrica y las evaluaciones han sido reiniciadas. Tus grupos y datos institucionales y de niveles permanecen guardados.", 'success');
        }


        // --- Lógica de Añadir y Gestionar Estudiantes (con tarjetas) ---

        /**
         * Renderiza las tarjetas de grupo de estudiantes.
         */
        function renderGroupCards() {
            groupCardsContainer.innerHTML = ''; // Limpiar el contenedor
            colorIndex = 0; // Resetear el índice de color cada vez que se renderiza

            if (Object.keys(studentGroups).length === 0) {
                groupCardsContainer.innerHTML = '<p class="text-center text-gray-500 col-span-full">No hay grupos de estudiantes guardados.</p>';
                return;
            }

            for (const groupName in studentGroups) {
                const groupStudents = studentGroups[groupName];
                const card = document.createElement('div');
                const currentColorClass = cardColors[colorIndex % cardColors.length];
                colorIndex++; // Avanzar al siguiente color

                card.className = `group-card ${currentColorClass} border-2 border-transparent`; // Añadir border-2 para el active
                card.dataset.groupName = groupName;

                // Resaltar la tarjeta si es el grupo actualmente seleccionado
                if (groupName === currentSelectedGroupName) {
                    card.classList.add('active');
                }

                card.innerHTML = `
                    <div class="flex items-center mb-2">
                        <i class="fas fa-users text-2xl text-indigo-700 mr-3"></i>
                        <h4 class="text-lg font-semibold text-gray-800">${groupName}</h4>
                    </div>
                    <p class="text-sm text-gray-600">${groupStudents.length} estudiantes</p>
                    <div class="group-actions">
                        <button class="load-group-card-btn bg-indigo-500 text-white hover:bg-indigo-600">
                            <i class="fas fa-folder-open"></i> Cargar
                        </button>
                        <button class="delete-group-card-btn bg-red-500 text-white hover:bg-red-600">
                            <i class="fas fa-trash-alt"></i> Eliminar
                        </button>
                    </div>
                `;
                groupCardsContainer.appendChild(card);
            }
            attachGroupCardEventListeners(); // Adjuntar listeners después de renderizar
        }

        /**
         * Adjunta event listeners a las tarjetas de grupo (usando delegación).
         */
        function attachGroupCardEventListeners() {
            groupCardsContainer.addEventListener('click', (event) => {
                const targetButton = event.target.closest('button');
                if (!targetButton) return; // No es un botón

                const card = targetButton.closest('.group-card');
                if (!card) return; // El botón no está dentro de una tarjeta de grupo

                const groupName = card.dataset.groupName;

                if (targetButton.classList.contains('load-group-card-btn')) {
                    loadGroupForEvaluation(groupName);
                } else if (targetButton.classList.contains('delete-group-card-btn')) {
                    deleteGroup(groupName);
                }
            });
        }

        /**
         * Carga un grupo de estudiantes para la evaluación.
         * @param {string} groupName - El nombre del grupo a cargar.
         */
        function loadGroupForEvaluation(groupName) {
            if (currentStudents.length > 0 && rubric.aspects.length > 0 && rubric.levels.length > 0 && Object.keys(rubric.descriptors).length > 0 && Object.keys(rubric.levelScores).length > 0) {
                const confirmChangeGroup = window.confirm("Ya tienes una rúbrica activa. ¿Estás seguro de que quieres cambiar a este grupo? Se perderán las evaluaciones no guardadas de la rúbrica actual (si las hay) y se cargarán las evaluaciones de este grupo.");
                if (!confirmChangeGroup) {
                    return;
                }
            }

            currentStudents = studentGroups[groupName];
            currentSelectedGroupName = groupName; // Actualizar la variable global del grupo seleccionado
            saveData();
            highlightSelectedGroupCard(groupName); // Resaltar la tarjeta activa
            showMessage(studentMessageBox, `¡Grupo "${groupName}" cargado para evaluación!`, 'success');

            showScreen('rubric-config-screen');
            currentStudentIndex = 0; // Resetear el índice del estudiante al cargar un nuevo grupo

            if (rubric.aspects.length > 0 && rubric.levels.length > 0 && Object.keys(rubric.descriptors).length > 0 && Object.keys(rubric.levelScores).length > 0) {
                showScreen('evaluation-screen');
            }
        }

        /**
         * Resalta la tarjeta del grupo seleccionado y desactiva las demás.
         * @param {string} selectedGroupName - El nombre del grupo cuya tarjeta se va a resaltar.
         */
        function highlightSelectedGroupCard(selectedGroupName) {
            const allCards = groupCardsContainer.querySelectorAll('.group-card');
            allCards.forEach(card => {
                card.classList.remove('active');
                if (card.dataset.groupName === selectedGroupName) {
                    card.classList.add('active');
                }
            });
        }

        /**
         * Elimina un grupo de estudiantes.
         * @param {string} groupName - El nombre del grupo a eliminar.
         */
        function deleteGroup(groupName) {
            const confirmDelete = window.confirm(`¿Estás seguro de que quieres eliminar el grupo "${groupName}"? Ten en cuenta que esto NO eliminará las evaluaciones asociadas a este grupo si ya se han realizado. Para borrar evaluaciones individuales, necesitarías reiniciar la rúbrica.`);
            if (confirmDelete) {
                delete studentGroups[groupName];
                if (currentSelectedGroupName === groupName) {
                    currentSelectedGroupName = ''; // Deseleccionar si el grupo actual es el eliminado
                    currentStudents = [];
                    localStorage.removeItem('currentSelectedGroupName');
                }
                saveData();
                renderGroupCards(); // Volver a renderizar las tarjetas
                showMessage(studentMessageBox, `Grupo "${groupName}" eliminado.`, 'success');
            }
        }


        // Event listener para el botón principal de guardar lista de estudiantes
        addStudentsBtn.addEventListener('click', () => {
            const rawList = studentListInput.value.trim();
            let groupName = groupNameInput.value.trim();

            if (!rawList) {
                showMessage(studentMessageBox, "Por favor, introduce la lista de estudiantes.", 'error');
                return;
            }

            const newStudents = rawList.split('\n')
                                      .map(name => name.trim())
                                      .filter(name => name !== '')
                                      .filter((name, index, self) => self.indexOf(name) === index);

            if (newStudents.length === 0) {
                showMessage(studentMessageBox, "No se encontraron nombres de estudiantes válidos en la lista.", 'error');
                return;
            }

            let targetGroupName;
            let actionMessage = "";

            if (groupName) {
                targetGroupName = groupName;
                studentGroups[targetGroupName] = newStudents;
                actionMessage = `¡Grupo "${targetGroupName}" con ${newStudents.length} estudiantes guardado (o actualizado)!`;
            } else { // Crear nuevo grupo anónimo o añadir a uno existente si hay selección
                targetGroupName = `Grupo - ${new Date().toLocaleDateString('es-ES')}`;
                let counter = 1;
                while(studentGroups[targetGroupName]) {
                    targetGroupName = `Grupo - ${new Date().toLocaleDateString('es-ES')} (${counter})`;
                    counter++;
                }
                studentGroups[targetGroupName] = newStudents;
                actionMessage = `¡Nuevo grupo anónimo "${targetGroupName}" con ${newStudents.length} estudiantes creado!`;
            }

            currentStudents = studentGroups[targetGroupName];
            currentSelectedGroupName = targetGroupName; // Actualizar la variable global del grupo seleccionado
            saveData();
            renderGroupCards(); // Volver a renderizar las tarjetas para mostrar el nuevo/actualizado
            highlightSelectedGroupCard(targetGroupName); // Resaltar el grupo recién guardado
            showMessage(studentMessageBox, actionMessage, 'success');

            groupNameInput.value = '';
            studentListInput.value = '';
        });

        // --- Lógica de Gestión de Niveles de Desempeño ---
        /**
         * Rellena el selector de grupos de niveles con los grupos guardados.
         */
        function renderLevelGroupSelectForManagement() {
            levelGroupSelectForManagement.innerHTML = '<option value="">-- Seleccionar Grupo de Niveles --</option>';
            for (const groupName in savedLevelGroups) {
                const option = document.createElement('option');
                option.value = groupName;
                option.textContent = groupName;
                levelGroupSelectForManagement.appendChild(option);
            }
        }

        /**
         * Guarda un nuevo grupo de niveles o actualiza uno existente.
         */
        saveLevelGroupBtn.addEventListener('click', () => {
            const groupName = levelGroupNameInput.value.trim();
            const rawLevels = levelListInput.value.trim();

            if (!groupName) {
                showMessage(levelManagementMessageBox, "Por favor, introduce un nombre para el grupo de niveles.", 'error');
                return;
            }
            if (!rawLevels) {
                showMessage(levelManagementMessageBox, "Por favor, introduce los niveles de desempeño (uno por línea).", 'error');
                return;
            }

            const newLevels = rawLevels.split('\n')
                                       .map(level => level.trim())
                                       .filter(level => level !== '')
                                       .filter((level, index, self) => self.indexOf(level) === index);

            if (newLevels.length === 0) {
                showMessage(levelManagementMessageBox, "No se encontraron niveles de desempeño válidos en la lista.", 'error');
                return;
            }

            savedLevelGroups[groupName] = newLevels;
            saveData();
            renderLevelGroupSelectForManagement();
            renderRubricLevelGroupSelect(); 
            levelGroupSelectForManagement.value = groupName;
            levelGroupNameInput.value = '';
            levelListInput.value = '';
            showMessage(levelManagementMessageBox, `¡Grupo de niveles "${groupName}" guardado (${newLevels.length} niveles)!`, 'success');
        });

        /**
         * Carga los niveles de un grupo seleccionado en el textarea para edición.
         */
        loadLevelGroupBtn.addEventListener('click', () => {
            const selectedGroup = levelGroupSelectForManagement.value;
            if (!selectedGroup) {
                showMessage(levelManagementMessageBox, "Por favor, selecciona un grupo de niveles para cargar.", 'error');
                return;
            }
            levelGroupNameInput.value = selectedGroup;
            levelListInput.value = savedLevelGroups[selectedGroup].join('\n');
            showMessage(levelManagementMessageBox, `Grupo de niveles "${selectedGroup}" cargado para edición.`, 'success');
        });

        /**
         * Elimina un grupo de niveles seleccionado.
         */
        deleteLevelGroupBtn.addEventListener('click', () => {
            const selectedGroup = levelGroupSelectForManagement.value;
            if (!selectedGroup) {
                showMessage(levelManagementMessageBox, "Por favor, selecciona un grupo de niveles para eliminar.", 'error');
                return;
            }

            const confirmDelete = window.confirm(`¿Estás seguro de que quieres eliminar el grupo de niveles "${selectedGroup}"? Esto no afectará las rúbricas ya creadas, pero no podrás seleccionarlo para nuevas rúbricas.`);
            if (confirmDelete) {
                delete savedLevelGroups[selectedGroup];
                saveData();
                renderLevelGroupSelectForManagement();
                renderRubricLevelGroupSelect(); 
                levelGroupNameInput.value = '';
                levelListInput.value = '';
                showMessage(levelManagementMessageBox, `Grupo de niveles "${selectedGroup}" eliminado.`, 'success');
            }
        });


        // --- Lógica de Configuración de Rúbrica (parte de selección de niveles) ---
        /**
         * Rellena el selector de grupos de niveles en la pantalla de configuración de rúbrica.
         */
        function renderRubricLevelGroupSelect() {
            rubricLevelsGroupSelect.innerHTML = '<option value="">-- Seleccionar Grupo de Niveles --</option>';
            for (const groupName in savedLevelGroups) {
                const option = document.createElement('option');
                option.value = groupName;
                option.textContent = groupName;
                rubricLevelsGroupSelect.appendChild(option);
            }
            if (rubric.selectedLevelGroupName && savedLevelGroups[rubric.selectedLevelGroupName]) {
                rubricLevelsGroupSelect.value = rubric.selectedLevelGroupName;
            }
        }

        // Función auxiliar para añadir y renderizar elementos en listas guardadas
        function addAndRenderItem(inputElement, dataArray, selectElement, messageBox, storageKey, messageType) {
            const newItem = inputElement.value.trim();
            if (newItem) { 
                if (!dataArray.includes(newItem)) { 
                    dataArray.push(newItem);
                    dataArray.sort(); 
                    renderDropdownOptions(selectElement, dataArray);
                    selectElement.value = newItem; 
                    inputElement.value = ''; 
                    localStorage.setItem(storageKey, JSON.stringify(dataArray));
                    showMessage(messageBox, messageType, 'success');
                } else {
                     showMessage(messageBox, 'El elemento ya existe en la lista.', 'error');
                }
            } else {
                showMessage(messageBox, 'Por favor, introduce un valor para añadir.', 'error');
            }
        }

        // Event listeners para añadir nuevas opciones permanentes (Institución, Curso, Docente)
        addInstitutionBtn.addEventListener('click', () => addAndRenderItem(newInstitutionInput, savedInstitutions, institutionSelect, rubricConfigMessageBox, 'savedInstitutions', 'Institución añadida.'));
        addCourseBtn.addEventListener('click', () => addAndRenderItem(newCourseInput, savedCourses, courseSelect, rubricConfigMessageBox, 'savedCourses', 'Curso añadido.'));
        addTeacherBtn.addEventListener('click', () => addAndRenderItem(newTeacherInput, savedTeachers, teacherSelect, rubricConfigMessageBox, 'savedTeachers', 'Docente añadido.'));

        // Event listeners para alternar inputs de añadir (Institución, Curso, Docente)
        toggleInstitutionInput.addEventListener('click', () => newInstitutionInput.classList.toggle('hidden'));
        toggleCourseInput.addEventListener('click', () => newCourseInput.classList.toggle('hidden'));
        toggleTeacherInput.addEventListener('click', () => newTeacherInput.classList.toggle('hidden'));


        /**
         * Genera la tabla de descriptores de la rúbrica para edición y los inputs de puntaje.
         */
        generateRubricBtn.addEventListener('click', () => {
            rubric.institution = institutionSelect.value;
            rubric.course = courseSelect.value;
            rubric.teacher = teacherSelect.value;
            rubric.sessionTitle = sessionTitleInput.value.trim();
            rubric.date = dateInput.value.trim();

            if (!rubric.institution) {
                showMessage(rubricConfigMessageBox, "Por favor, selecciona o añade una Institución Educativa.", 'error');
                return;
            }
            if (!rubric.course) {
                showMessage(rubricConfigMessageBox, "Por favor, selecciona o añade un Curso/Módulo.", 'error');
                return;
            }
            if (!rubric.teacher) {
                showMessage(rubricConfigMessageBox, "Por favor, selecciona o añade un Docente.", 'error');
                return;
            }


            const rawAspects = aspectsInput.value.trim();
            rubric.selectedLevelGroupName = rubricLevelsGroupSelect.value; 
            
            if (!rubric.selectedLevelGroupName) {
                showMessage(rubricConfigMessageBox, "Por favor, selecciona un Grupo de Niveles de Desempeño.", 'error');
                return;
            }

            rubric.levels = savedLevelGroups[rubric.selectedLevelGroupName]; 

            if (!rawAspects) {
                showMessage(rubricConfigMessageBox, "Por favor, introduce los aspectos a evaluar.", 'error');
                return;
            }
            if (rubric.levels.length === 0) { 
                showMessage(rubricConfigMessageBox, "El grupo de niveles seleccionado no contiene niveles. Por favor, edítalo o selecciona otro.", 'error');
                return;
            }

            rubric.aspects = rawAspects.split('\n')
                                       .map(aspect => aspect.trim())
                                       .filter(aspect => aspect !== '')
                                       .filter((aspect, index, self) => self.indexOf(aspect) === index); 
            
            if (rubric.aspects.length === 0) {
                showMessage(rubricConfigMessageBox, "No se encontraron aspectos válidos a evaluar.", 'error');
                return;
            }

            // Inicializar descriptores si no existen o si los aspectos/niveles han cambiado
            const newDescriptors = {};
            rubric.aspects.forEach(aspect => {
                newDescriptors[aspect] = {};
                rubric.levels.forEach(level => {
                    newDescriptors[aspect][level] = (rubric.descriptors[aspect] && rubric.descriptors[aspect][level]) || '';
                });
            });
            rubric.descriptors = newDescriptors;

            // Inicializar puntajes de niveles si no existen
            const newLevelScores = {};
            rubric.levels.forEach((level, index) => {
                newLevelScores[level] = rubric.levelScores[level] || (rubric.levels.length - index);
            });
            rubric.levelScores = newLevelScores;

            renderLevelScoresInputs();
            renderDescriptorsTable();
            rubricDescriptorsEditor.classList.remove('hidden');
            showMessage(rubricConfigMessageBox, "Rúbrica generada. ¡Ahora define los puntajes y edita los descriptores!", 'success');
        });

        /**
         * Renderiza los inputs para definir los puntajes de cada nivel.
         */
        function renderLevelScoresInputs() {
            let inputsHTML = '';
            rubric.levels.forEach(level => {
                inputsHTML += `
                    <div>
                        <label for="score-${level.replace(/\s/g, '-')}" class="block text-gray-700 font-medium mb-1">${level}:</label>
                        <input
                            type="number"
                            id="score-${level.replace(/\s/g, '-')}"
                            class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-400 focus:border-blue-400"
                            value="${rubric.levelScores[level] || ''}"
                            min="0"
                        />
                    </div>
                `;
            });
            levelScoresInputArea.innerHTML = inputsHTML;
        }

        /**
         * Renderiza la tabla para editar los descriptores de la rúbrica.
         */
        function renderDescriptorsTable() {
            let tableHTML = `
                <table class="w-full table-fixed bg-white border border-gray-300 rounded-lg shadow-sm">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="py-3 px-4 text-left text-gray-700 font-semibold border-b" style="width: 120px;">Aspectos a Evaluar</th>
                            ${rubric.levels.map(level => `<th class="py-3 px-4 text-left text-gray-700 font-semibold border-b" style="width: 180px;">${level}</th>`).join('')}
                        </tr>
                    </thead>
                    <tbody>
            `;

            rubric.aspects.forEach(aspect => {
                tableHTML += `
                    <tr>
                        <td class="py-3 px-4 border-b text-gray-800 font-medium" style="width: 120px;">${aspect}</td>
                        ${rubric.levels.map(level => `
                            <td class="py-2 px-4 border-b" style="width: 180px;">
                                <textarea
                                    id="descriptor-${aspect.replace(/\s/g, '-')}-${level.replace(/\s/g, '-')}"
                                    class="w-full p-2 text-sm border border-gray-200 rounded-md focus:ring-blue-400 focus:border-blue-400"
                                    rows="3"
                                    placeholder="Descriptor para ${level}"
                                >${rubric.descriptors[aspect][level] || ''}</textarea>
                            </td>
                        `).join('')}
                    </tr>
                `;
            });

            tableHTML += `
                    </tbody>
                </table>
            `;
            descriptorsTable.innerHTML = tableHTML;
        }

        /**
         * Guarda los descriptores editados y pasa a la sección de evaluación.
         */
        saveRubricBtn.addEventListener('click', () => {
            rubric.institution = institutionSelect.value;
            rubric.course = courseSelect.value;
            rubric.sessionTitle = sessionTitleInput.value.trim();
            rubric.teacher = teacherSelect.value;
            rubric.date = dateInput.value.trim();
            rubric.generalObservations = generalObservationsInput.value.trim();
            rubric.selectedLevelGroupName = rubricLevelsGroupSelect.value;

            let allScoresValid = true;
            rubric.levels.forEach(level => {
                const scoreInputId = `score-${level.replace(/\s/g, '-')}`;
                const scoreInput = document.getElementById(scoreInputId);
                if (scoreInput && !isNaN(parseInt(scoreInput.value))) {
                    rubric.levelScores[level] = parseInt(scoreInput.value);
                } else {
                    showMessage(rubricConfigMessageBox, `Por favor, ingresa un puntaje válido para el nivel '${level}'.`, 'error');
                    allScoresValid = false;
                    return;
                }
            });

            if (!allScoresValid) return;


            rubric.aspects.forEach(aspect => {
                rubric.levels.forEach(level => {
                    const textareaId = `descriptor-${aspect.replace(/\s/g, '-')}-${level.replace(/\s/g, '-')}`;
                    const textarea = document.getElementById(textareaId);
                    if (textarea) {
                        rubric.descriptors[aspect][level] = textarea.value.trim();
                    }
                });
            });

            const currentGroupName = currentSelectedGroupName; // Usar la variable global
            currentStudents.forEach(student => {
                const evaluationKey = `${currentGroupName}_${student}`;
                if (!evaluations[evaluationKey]) {
                    evaluations[evaluationKey] = {};
                    rubric.aspects.forEach(aspect => {
                        evaluations[evaluationKey][aspect] = null;
                    });
                }
            });

            saveData();
            showMessage(rubricConfigMessageBox, "¡Rúbrica guardada y lista para la evaluación!", 'success');

            showScreen('evaluation-screen');
            currentStudentIndex = 0;
            renderStudentEvaluation();
        });

        // --- Lógica de Evaluación de Estudiantes ---

        /**
         * Renderiza la rúbrica para el estudiante actual y sus evaluaciones.
         */
        function renderStudentEvaluation() {
            if (currentStudents.length === 0) {
                currentStudentName.textContent = "No hay estudiantes";
                studentRubricDisplay.innerHTML = "";
                return;
            }

            const studentName = currentStudents[currentStudentIndex];
            currentStudentName.textContent = studentName;
            studentIndexSpan.textContent = currentStudentIndex + 1;
            totalStudentsSpan.textContent = currentStudents.length;

            const evaluationKey = `${currentSelectedGroupName}_${studentName}`; // Usar currentSelectedGroupName

            let tableHTML = `
                <table class="min-w-full bg-white border border-gray-300 rounded-lg overflow-hidden shadow-sm">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="py-3 px-4 text-left text-gray-700 font-semibold border-b">Aspecto</th>
                            <th class="py-3 px-4 text-left text-gray-700 font-semibold border-b">Nivel Asignado</th>
                            <th class="py-3 px-4 text-left text-gray-700 font-semibold border-b">Puntaje</th>
                            <th class="py-3 px-4 text-left text-gray-700 font-semibold border-b">Descriptores (Haz clic para asignar)</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            rubric.aspects.forEach(aspect => {
                const currentLevel = evaluations[evaluationKey] ? evaluations[evaluationKey][aspect] : null; 
                const currentScore = currentLevel ? rubric.levelScores[currentLevel] || 0 : 0; 
                tableHTML += `
                    <tr>
                        <td class="py-3 px-4 border-b text-gray-800 font-medium">${aspect}</td>
                        <td class="py-3 px-4 border-b">
                            <span class="font-bold text-blue-600">${currentLevel || 'N/A'}</span>
                        </td>
                        <td class="py-3 px-4 border-b">
                            <span class="font-bold text-green-600">${currentScore}</span>
                        </td>
                        <td class="py-2 px-4 border-b">
                            <div class="flex flex-wrap gap-2">
                                ${rubric.levels.map(level => {
                                    const descriptor = rubric.descriptors[aspect][level] || 'Sin descriptor';
                                    const isSelected = currentLevel === level;
                                    const buttonClasses = `
                                        flex-grow min-w-0 p-2 text-sm border rounded-md cursor-pointer
                                        ${isSelected ? 'bg-blue-200 border-blue-500 text-blue-800 shadow-md' : 'bg-gray-100 border-gray-300 text-gray-700 hover:bg-gray-200'}
                                        transition duration-200 ease-in-out
                                        text-left
                                    `;
                                    return `
                                        <button
                                            data-aspect="${aspect}"
                                            data-level="${level}"
                                            class="${buttonClasses}"
                                            title="${descriptor}"
                                        >
                                            <span class="font-semibold">${level} (${rubric.levelScores[level] || 0} pts):</span> ${descriptor}
                                        </button>
                                    `;
                                }).join('')}
                            </div>
                        </td>
                    </tr>
                `;
            });

            tableHTML += `
                    </tbody>
                </table>
            `;
            studentRubricDisplay.innerHTML = tableHTML;

            studentRubricDisplay.querySelectorAll('button[data-aspect][data-level]').forEach(button => {
                button.addEventListener('click', (event) => {
                    const aspect = event.currentTarget.dataset.aspect;
                    const level = event.currentTarget.dataset.level;
                    evaluateAspect(studentName, aspect, level);
                });
            });

            prevStudentBtn.disabled = currentStudentIndex === 0;
            nextStudentBtn.disabled = currentStudentIndex === currentStudents.length - 1;
            if (currentStudentIndex === currentStudents.length - 1) {
                finishEvaluationBtn.classList.remove('hidden');
                nextStudentBtn.classList.add('hidden'); 
            } else {
                finishEvaluationBtn.classList.add('hidden');
                nextStudentBtn.classList.remove('hidden');
            }
        }

        /**
         * Asigna un nivel a un aspecto para un estudiante dado.
         * @param {string} studentName - Nombre del estudiante.
         * @param {string} aspect - Aspecto evaluado.
         * @param {string} level - Nivel de desempeño asignado.
         */
        function evaluateAspect(studentName, aspect, level) {
            const evaluationKey = `${currentSelectedGroupName}_${studentName}`;
            if (!evaluations[evaluationKey]) {
                evaluations[evaluationKey] = {};
            }
            evaluations[evaluationKey][aspect] = level;
            saveData(); 
            renderStudentEvaluation(); 
            showMessage(evaluationMessageBox, `Evaluación para '${aspect}' del estudiante '${studentName}' actualizada a '${level}'.`, 'success');
        }

        /**
         * Navega al estudiante anterior.
         */
        prevStudentBtn.addEventListener('click', () => {
            if (currentStudentIndex > 0) {
                currentStudentIndex--;
                renderStudentEvaluation();
            }
        });

        /**
         * Navega al siguiente estudiante.
         */
        nextStudentBtn.addEventListener('click', () => {
            if (currentStudentIndex < currentStudents.length - 1) {
                currentStudentIndex++;
                renderStudentEvaluation();
            }
        });

        /**
         * Finaliza la evaluación y muestra la sección de reporte.
         */
        finishEvaluationBtn.addEventListener('click', () => {
            showScreen('report-screen');
        });

        /**
         * Vuelve a la sección de evaluación.
         */
        backToEvaluationBtn.addEventListener('click', () => {
            showScreen('evaluation-screen');
        });

        /**
         * Inicia una nueva rúbrica desde cero.
         */
        newRubricBtn.addEventListener('click', () => {
            const confirmReset = window.confirm("¿Estás seguro de que quieres iniciar una nueva rúbrica? Esto borrará solo la configuración actual de la rúbrica y las evaluaciones realizadas, pero tus grupos de estudiantes y datos institucionales guardados PERMANECERÁN.");
            if (confirmReset) {
                resetApp();
            }
        });

        // --- Lógica de Exportación a PDF ---

        /**
         * Genera un PDF para un único estudiante.
         * @param {string} studentName - El nombre del estudiante para el cual se generará el PDF.
         * @param {string} groupName - El nombre del grupo al que pertenece el estudiante.
         */
        function generateSingleStudentPdf(studentName, groupName) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({
                orientation: 'portrait',
                unit: 'mm',
                format: 'a4'
            });

            doc.setFont("helvetica");
            let yOffset = 20;
            const margin = 20;

            // Información general de la rúbrica
            doc.setFontSize(22);
            doc.setTextColor(40, 40, 40);
            doc.text("Rúbrica de Evaluación", doc.internal.pageSize.width / 2, yOffset, { align: 'center' });
            yOffset += 10; 

            doc.setFontSize(14); 
            doc.setTextColor(50, 50, 50);
            doc.text(`Grupo: ${groupName || 'N/A'}`, doc.internal.pageSize.width / 2, yOffset, { align: 'center' });
            yOffset += 10; 

            doc.setFontSize(10);
            doc.setTextColor(80, 80, 80);
            doc.text(`Institución Educativa: ${rubric.institution || 'N/A'}`, margin, yOffset);
            yOffset += 5;
            doc.text(`Curso/Módulo: ${rubric.course || 'N/A'}`, margin, yOffset);
            yOffset += 5;
            doc.text(`Título de la sesión: ${rubric.sessionTitle || 'N/A'}`, margin, yOffset);
            yOffset += 5;
            doc.text(`Docente: ${rubric.teacher || 'N/A'}`, margin, yOffset);
            yOffset += 5;
            doc.text(`Fecha: ${rubric.date || 'N/A'}`, margin, yOffset);
            yOffset += 10;

            if (rubric.generalObservations) {
                doc.setFontSize(10);
                doc.setTextColor(60, 60, 60);
                doc.text("Observaciones Generales de la Rúbrica:", margin, yOffset);
                yOffset += 5;
                const splitObservations = doc.splitTextToSize(rubric.generalObservations, doc.internal.pageSize.width - (2 * margin));
                doc.text(splitObservations, margin, yOffset);
                yOffset += (splitObservations.length * 4) + 10;
            }

            // Título del estudiante
            doc.setFontSize(16);
            doc.setTextColor(0, 70, 150);
            doc.text(`Estudiante: ${studentName}`, margin, yOffset);
            yOffset += 8;

            doc.setFontSize(9);
            doc.setTextColor(80, 80, 80);

            const headers = ["Aspecto", "Nivel Asignado", "Puntaje", "Descriptor"];
            const tableColumnWidths = [40, 25, 15, 90];

            const evaluationKey = `${groupName}_${studentName}`;
            const tableData = [];
            let studentTotalScore = 0;
            let hasEvaluatedAspects = false;

            rubric.aspects.forEach(aspect => {
                const assignedLevel = evaluations[evaluationKey] ? evaluations[evaluationKey][aspect] || 'No Evaluado' : 'No Evaluado';
                const scoreForAspect = rubric.levelScores[assignedLevel] || 0;
                const descriptorText = rubric.descriptors[aspect][assignedLevel] || 'N/A';
                tableData.push([aspect, assignedLevel, scoreForAspect, descriptorText]);

                if (assignedLevel !== 'No Evaluado') {
                    studentTotalScore += scoreForAspect;
                    hasEvaluatedAspects = true;
                }
            });

            let maxPossibleScore = 0;
            rubric.aspects.forEach(aspect => {
                let maxAspectScore = 0;
                rubric.levels.forEach(level => {
                    const score = rubric.levelScores[level] || 0;
                    if (score > maxAspectScore) {
                        maxAspectScore = score;
                    }
                });
                maxPossibleScore += maxAspectScore;
            });

            doc.autoTable({
                startY: yOffset,
                head: [headers],
                body: tableData,
                theme: 'grid',
                styles: {
                    fontSize: 7,
                    cellPadding: 1.5,
                    valign: 'middle',
                    halign: 'left',
                    textColor: [50, 50, 50],
                },
                headStyles: {
                    fillColor: [220, 220, 220],
                    textColor: [0, 0, 0],
                    fontStyle: 'bold',
                },
                columnStyles: {
                    0: { cellWidth: tableColumnWidths[0] },
                    1: { cellWidth: tableColumnWidths[1] },
                    2: { cellWidth: tableColumnWidths[2], halign: 'center' },
                    3: { cellWidth: tableColumnWidths[3] }
                },
                didDrawPage: function (data) {
                    let str = "Página " + doc.internal.getNumberOfPages();
                    doc.setFontSize(8);
                    doc.setTextColor(150);
                    doc.text(str, data.settings.margin.left, doc.internal.pageSize.height - 10);
                }
            });

            yOffset = doc.autoTable.previous.finalY;

            doc.setFontSize(10);
            doc.setTextColor(0, 100, 0);
            doc.text(`Puntaje Final: ${studentTotalScore} / ${maxPossibleScore} pts`, margin, yOffset + 5);

            const studentAverageScore = hasEvaluatedAspects ? (studentTotalScore / rubric.aspects.length).toFixed(2) : 'N/A';
            doc.text(`Promedio por Aspecto: ${studentAverageScore}`, margin, yOffset + 10);
            yOffset += 20;

            const safeStudentName = studentName.replace(/[^a-z0-9]/gi, '_');
            const safeGroupName = groupName.replace(/[^a-z0-9]/gi, '_');
            doc.save(`rubrica_${safeStudentName}_${safeGroupName}.pdf`);
        }

        /**
         * Exporta todas las evaluaciones a archivos PDF individuales (un PDF por estudiante).
         */
        exportIndividualRubricsBtn.addEventListener('click', async () => {
            if (currentStudents.length === 0) {
                showMessage(reportMessageBox, "No hay estudiantes en el grupo actual para generar reportes individuales.", 'error');
                return;
            }
            if (rubric.aspects.length === 0 || Object.keys(rubric.levelScores).length === 0) {
                showMessage(reportMessageBox, "Por favor, configura la rúbrica completa y asigna puntajes a los niveles antes de exportar.", 'error');
                return;
            }

            const currentGroupName = currentSelectedGroupName;
            for (const student of currentStudents) {
                generateSingleStudentPdf(student, currentGroupName);
            }
            showMessage(reportMessageBox, "¡Rúbricas individuales generadas y descargadas!", 'success');
        });

        /**
         * Exporta todas las evaluaciones a un único archivo PDF.
         */
        exportPdfBtn.addEventListener('click', async () => {
            if (currentStudents.length === 0) {
                showMessage(reportMessageBox, "No hay estudiantes en el grupo actual para generar el reporte.", 'error');
                return;
            }
            if (rubric.aspects.length === 0 || Object.keys(rubric.levelScores).length === 0) {
                showMessage(reportMessageBox, "Por favor, configura la rúbrica completa y asigna puntajes a los niveles.", 'error');
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({
                orientation: 'portrait',
                unit: 'mm',
                format: 'a4'
            });

            doc.setFont("helvetica");

            let yOffset = 20; 
            const margin = 20; 

            doc.setFontSize(22);
            doc.setTextColor(40, 40, 40);
            doc.text("Reporte General de Evaluación de Estudiantes", doc.internal.pageSize.width / 2, yOffset, { align: 'center' });
            yOffset += 10; 

            doc.setFontSize(14); 
            doc.setTextColor(50, 50, 50);
            doc.text(`Grupo: ${currentSelectedGroupName || 'N/A'}`, doc.internal.pageSize.width / 2, yOffset, { align: 'center' });
            yOffset += 10; 

            doc.setFontSize(10);
            doc.setTextColor(80, 80, 80);
            doc.text(`Institución Educativa: ${rubric.institution || 'N/A'}`, margin, yOffset);
            yOffset += 5;
            doc.text(`Curso/Módulo: ${rubric.course || 'N/A'}`, margin, yOffset);
            yOffset += 5;
            doc.text(`Título de la sesión: ${rubric.sessionTitle || 'N/A'}`, margin, yOffset);
            yOffset += 5;
            doc.text(`Docente: ${rubric.teacher || 'N/A'}`, margin, yOffset);
            yOffset += 5;
            doc.text(`Fecha: ${rubric.date || 'N/A'}`, margin, yOffset);
            yOffset += 10;

            if (rubric.generalObservations) {
                doc.setFontSize(10);
                doc.setTextColor(60, 60, 60);
                doc.text("Observaciones Generales de la Rúbrica:", margin, yOffset);
                yOffset += 5;
                const splitObservations = doc.splitTextToSize(rubric.generalObservations, doc.internal.pageSize.width - (2 * margin));
                doc.text(splitObservations, margin, yOffset);
                yOffset += (splitObservations.length * 4) + 10;
            }

            let maxPossibleScore = 0;
            rubric.aspects.forEach(aspect => {
                let maxAspectScore = 0;
                rubric.levels.forEach(level => {
                    const score = rubric.levelScores[level] || 0;
                    if (score > maxAspectScore) {
                        maxAspectScore = score;
                    }
                });
                maxPossibleScore += maxAspectScore;
            });

            let totalSumOfFinalScores = 0;
            let evaluatedStudentCount = 0;

            const currentGroupName = currentSelectedGroupName;

            for (const student of currentStudents) { 
                if (yOffset > 270) {
                    doc.addPage();
                    yOffset = 20;
                    doc.setFontSize(10);
                    doc.setTextColor(80, 80, 80);
                    doc.text(`Institución Educativa: ${rubric.institution || 'N/A'}`, margin, yOffset);
                    yOffset += 5;
                    doc.text(`Curso/Módulo: ${rubric.course || 'N/A'}`, margin, yOffset);
                    yOffset += 5;
                    doc.text(`Título de la sesión: ${rubric.sessionTitle || 'N/A'}`, margin, yOffset);
                    yOffset += 5;
                    doc.text(`Docente: ${rubric.teacher || 'N/A'}`, margin, yOffset);
                    yOffset += 5;
                    doc.text(`Fecha: ${rubric.date || 'N/A'}`, margin, yOffset);
                    yOffset += 5;
                    doc.text(`Grupo de Estudiantes: ${currentSelectedGroupName || 'N/A'}`, margin, yOffset);
                    yOffset += 10;
                }

                // Título del estudiante
                doc.setFontSize(16);
                doc.setTextColor(0, 70, 150);
                doc.text(`Estudiante: ${student}`, margin, yOffset);
                yOffset += 8;

                doc.setFontSize(9);
                doc.setTextColor(80, 80, 80);

                const headers = ["Aspecto", "Nivel Asignado", "Puntaje", "Descriptor"];
                const tableColumnWidths = [40, 25, 15, 90];

                const evaluationKey = `${currentGroupName}_${student}`;
                const tableData = [];
                let studentTotalScore = 0;
                let hasEvaluatedAspects = false;

                rubric.aspects.forEach(aspect => {
                    const assignedLevel = evaluations[evaluationKey] ? evaluations[evaluationKey][aspect] || 'No Evaluado' : 'No Evaluado';
                    const scoreForAspect = rubric.levelScores[assignedLevel] || 0;
                    const descriptorText = rubric.descriptors[aspect][assignedLevel] || 'N/A';
                    tableData.push([aspect, assignedLevel, scoreForAspect, descriptorText]);

                    if (assignedLevel !== 'No Evaluado') {
                        studentTotalScore += scoreForAspect;
                        hasEvaluatedAspects = true;
                    }
                });

                if (hasEvaluatedAspects) {
                    totalSumOfFinalScores += studentTotalScore;
                    evaluatedStudentCount++;
                }

                doc.autoTable({
                    startY: yOffset,
                    head: [headers],
                    body: tableData,
                    theme: 'grid',
                    styles: {
                        fontSize: 7,
                        cellPadding: 1.5,
                        valign: 'middle',
                        halign: 'left',
                        textColor: [50, 50, 50],
                    },
                    headStyles: {
                        fillColor: [220, 220, 220],
                        textColor: [0, 0, 0],
                        fontStyle: 'bold',
                    },
                    columnStyles: {
                        0: { cellWidth: tableColumnWidths[0] },
                        1: { cellWidth: tableColumnWidths[1] },
                        2: { cellWidth: tableColumnWidths[2], halign: 'center' },
                        3: { cellWidth: tableColumnWidths[3] }
                    },
                    didDrawPage: function (data) {
                        let str = "Página " + doc.internal.getNumberOfPages();
                        doc.setFontSize(8);
                        doc.setTextColor(150);
                        doc.text(str, data.settings.margin.left, doc.internal.pageSize.height - 10);
                    }
                });

                yOffset = doc.autoTable.previous.finalY;

                doc.setFontSize(10);
                doc.setTextColor(0, 100, 0);
                doc.text(`Puntaje Final: ${studentTotalScore} / ${maxPossibleScore} pts`, margin, yOffset + 5);

                const studentAverageScore = hasEvaluatedAspects ? (studentTotalScore / rubric.aspects.length).toFixed(2) : 'N/A';
                doc.text(`Promedio por Aspecto: ${studentAverageScore}`, margin, yOffset + 10);
                yOffset += 20;
            }

            if (evaluatedStudentCount > 0) {
                const globalAverageScore = (totalSumOfFinalScores / evaluatedStudentCount).toFixed(2);
                doc.addPage();
                yOffset = 30;
                doc.setFontSize(20);
                doc.setTextColor(0, 0, 120);
                doc.text("Resumen General de Evaluaciones", doc.internal.pageSize.width / 2, yOffset, { align: 'center' });
                yOffset += 15;

                doc.setFontSize(12);
                doc.setTextColor(0, 0, 0);
                doc.text(`Número total de estudiantes evaluados en este grupo: ${evaluatedStudentCount}`, margin, yOffset);
                yOffset += 10;
                doc.text(`Puntaje Promedio Global (por estudiante) en este grupo: ${globalAverageScore} pts`, margin, yOffset);
                yOffset += 10;
                doc.text(`Puntaje Máximo Posible por estudiante: ${maxPossibleScore} pts`, margin, yOffset);
            }

            doc.save('reporte_general_evaluacion_grupo.pdf');
            showMessage(reportMessageBox, "¡Reporte PDF generado y descargado!", 'success');
        });

        // --- Inicialización ---

        // Cargar datos al iniciar la aplicación
        window.onload = loadData;

    </script>
</body>
</html>
